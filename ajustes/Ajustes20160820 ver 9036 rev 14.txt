DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then


insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),


ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),

0
 from tblinventario where tblinventario.idinventario>1;


    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventas on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblremision.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0 and tblventas.deremision=0),0),
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),



ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal) ,0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),


0
 from tblinventario where tblinventario.idinventario>1;

    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;

DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventarioclases` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventarioclases`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10),pidclase1 int,pidclase2 int,pidclase3 int)
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then

if pidclase3>0 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),


ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),

0
 from tblinventario where tblinventario.idinventario>1 and tblinventario.idclasificacion3=pidclase3;

else
 if pidclase2>0 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),


ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),

0
 from tblinventario where tblinventario.idinventario>1 and tblinventario.idclasificacion2=pidclase2;

else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),


ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0)

),0),

0
 from tblinventario where tblinventario.idinventario>1 and tblinventario.idclasificacion=pidclase1;

end if;

end if;

else
if pidclase3>0 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),



ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal) ,0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),


0
 from tblinventario where tblinventario.idinventario>1 and tblinventario.idclasificacion3=pidclase3;

else
 if pidclase2>0 then

 insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),



ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal) ,0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),


0
 from tblinventario where tblinventario.idinventario>1 and tblinventario.idclasificacion2=pidclase2;

 else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha3 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha3 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha3 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha3 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha3 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha3 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha3 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha3 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha3 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha3 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha3 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal),0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha3 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha3 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha3 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha3 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),



ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0 and tblventas.deremision=0),0)+
ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),

ifnull((
ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)


+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4) and tbldevolucionescompras.idsucursal=pidsucursal),0)

+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=tblinventario.idinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0 and tblventasapartados.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4 and tblcompras.idsucursal=pidsucursal
and tblcompras.deremision=0),0)

+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4 and tbldevolucionescompras.idsucursal=pidsucursal),0)

-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=tblinventario.idinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.idsucursal=pidsucursal) ,0)

+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=tblinventario.idinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal
and tblventas.deremision=0),0)/tblinventario.contenido

-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=tblinventario.idinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0)/tblinventario.contenido

-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0)

+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0)

),0),


0
 from tblinventario where tblinventario.idinventario>1 and tblinventario.idclasificacion=pidclase1;

 end if;
end if;
end if;



END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varsumarem double;
declare varsumaremc double;
delete from tblinventarioanalisisc;

if pidsucursal<=0 then

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;

set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0)+varsumaremc,3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;


set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0)+varsumaremc,0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;

set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0)+varsumaremc,3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;


set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0)+varsumaremc,0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
else

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal;

set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0)+varsumaremc,3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisiones.idsucursal=pidsucursal),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0)+varsumaremc,0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.idsucursal=pidsucursal;

set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.idsucursal=pidsucursal),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fechacancelado order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where tblventasremisiones.estado=4 and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.idsucursal=pidsucursal),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0)+varsumaremc,3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;


set varsumarem=ifnull((select sum(tblventasremisionesinventario.cantidad) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.idsucursal=pidsucursal),0);
set varsumaremc=ifnull((select sum(tblventasremisionesinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasremisionesinventario.idinventario and fecha<=tblventasremisiones.fecha order by fecha desc limit 1)) from tblventasremisionesinventario inner join tblventasremisiones on tblventasremisionesinventario.idremision=tblventasremisiones.idremision inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario where (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and tblventasremisiones.porsurtir=0 and tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.idsucursal=pidsucursal),0);
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0)+varsumarem,ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0)+varsumaremc,0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal and tblventas.deremision=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



end if;

end if;


return 0;


END $$

DELIMITER ;

ALTER TABLE `tbltrabajadores` ADD COLUMN `sindicalizado` TINYINT UNSIGNED NOT NULL DEFAULT 0 AFTER `idcuenta4`;

ALTER TABLE `tblnominas` ADD COLUMN `tipoNomina` VARCHAR(45) NOT NULL AFTER `horaCambio`;


insert into tbldeducciones(clave,descripcion,idcuenta)values('022','Impuestos Locales',0);
insert into tbldeducciones(clave,descripcion,idcuenta)values('023','Aportaciones voluntarias',0);

insert into tblpercepciones(clave,descripcion,idcuenta,visible)values('044','Jubilaciones, pensiones o haberes de retiro en parcialidades',0,1),
('045','Ingresos en acciones o ttulos valor que representan bienes',0,1),
('046','Ingresos asimilados o salarios',0,1),
('047','Alimentacin',0,1),
('048','Habitacin',0,1),
('049','Premios por asistencia',0,1);
update tblpercepciones set visible=0 where clave='016' or clave='017' or clave='018' or clave='040' or clave='041' or clave='042';

DROP TABLE IF EXISTS `tblnominasubcontratacion`;
CREATE TABLE  `tblnominasubcontratacion` (
  `idsubcontratacion` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idTrabajador` int(10) unsigned NOT NULL,
  `rfclaboral` varchar(45) NOT NULL,
  `porcentaje` double NOT NULL,
  PRIMARY KEY (`idsubcontratacion`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;


DROP TABLE IF EXISTS `tblnominatrabajador`;
CREATE TABLE  `tblnominatrabajador` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idNomina` int(10) unsigned NOT NULL,
  `idTrabajador` int(10) unsigned NOT NULL,
  `subsidio` double NOT NULL,
  `saldoFavor` double NOT NULL,
  `anho` double NOT NULL,
  `remanente` double NOT NULL,
  `origenrecurso` varchar(45) NOT NULL,
  `monto` double NOT NULL,
  `valormercado` double NOT NULL,
  `precioalotorgarse` double NOT NULL,
  `totalpagado` double NOT NULL,
  `anhosservicio` double NOT NULL,
  `sueldomensual` double NOT NULL,
  `acumulable1` double NOT NULL,
  `noacumulable1` double NOT NULL,
  `totalunaexhibicion` double NOT NULL,
  `totalparcialidad` double NOT NULL,
  `montodiario` double NOT NULL,
  `acumulable2` double NOT NULL,
  `noacumulable2` double NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


DROP TABLE IF EXISTS `tblnominaotrospagos`;
CREATE TABLE  `tblnominaotrospagos` (
  `idPago` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `tipoPago` varchar(45) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `concepto` varchar(45) NOT NULL,
  `importe` double NOT NULL,
  `idNomina` int(10) unsigned NOT NULL,
  PRIMARY KEY (`idPago`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;

ALTER TABLE `tblnominatrabajador` DROP COLUMN `idNomina`,
 DROP COLUMN `origenrecurso`,
 DROP COLUMN `monto`;


ALTER TABLE `tblnominas` ADD COLUMN `origenRecurso` VARCHAR(45) NOT NULL AFTER `tipoNomina`,
 ADD COLUMN `monto` DOUBLE NOT NULL AFTER `origenRecurso`;

ALTER TABLE `tblnominaotrospagos` CHANGE COLUMN `idNomina` `idTrabajador` INT(10) UNSIGNED NOT NULL;

ALTER TABLE `tblnominahorasextra` ADD COLUMN `idconcepto` INTEGER UNSIGNED NOT NULL AFTER `importepagado`;

ALTER TABLE `tblnominatrabajador` DROP COLUMN `valormercado`,
 DROP COLUMN `precioalotorgarse`;

ALTER TABLE `tblnominadetalles` ADD COLUMN `valormercado` DOUBLE NOT NULL AFTER `importeexento`,
 ADD COLUMN `precioalotorgarse` DOUBLE NOT NULL AFTER `valormercado`;

ALTER TABLE `tblnominatrabajador` DROP COLUMN `subsidio`,
 DROP COLUMN `saldoFavor`,
 DROP COLUMN `anho`,
 DROP COLUMN `remanente`;

ALTER TABLE `tblnominaotrospagos` ADD COLUMN `subsidio` DOUBLE NOT NULL AFTER `idTrabajador`,
 ADD COLUMN `saldoafavor` DOUBLE NOT NULL AFTER `subsidio`,
 ADD COLUMN `anhos` DOUBLE NOT NULL AFTER `saldoafavor`,
 ADD COLUMN `remanente` DOUBLE NOT NULL AFTER `anhos`;

ALTER TABLE `tblnominaotrospagos` CHANGE COLUMN `idTrabajador` `idnomina` INT(10) UNSIGNED NOT NULL;

ALTER TABLE `tblnominaotrospagos` ADD CONSTRAINT `FK_tblnominaotrospagos_1` FOREIGN KEY `FK_tblnominaotrospagos_1` (`idnomina`)
    REFERENCES `tblnominas` (`idnomina`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION;

ALTER TABLE `tblsucursales` ADD COLUMN `registropatronal` VARCHAR(45) NOT NULL AFTER `idtipo`;
update tblsucursales set registropatronal=ifnull((select registropatronal from tbltrabajadores limit 1),'');

ALTER TABLE `tbltrabajadores` ADD COLUMN `rfcpatronorigen` VARCHAR(15) NOT NULL AFTER `sindicalizado`;
ALTER TABLE `tblnominahorasextra` DROP COLUMN `idconcepto`;

CREATE TABLE `tblnominahorasextrac` (
  `idhoraextra` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `iddetalle` INTEGER UNSIGNED NOT NULL,
  `dias` DOUBLE NOT NULL,
  `tipohoras` VARCHAR(10) NOT NULL,
  `horasextra` INTEGER UNSIGNED NOT NULL,
  `importepagado` DOUBLE NOT NULL,
  PRIMARY KEY (`idhoraextra`),
  CONSTRAINT `FK_tblnominahorasextrac_1` FOREIGN KEY `FK_tblnominahorasextrac_1` (`iddetalle`)
    REFERENCES `tblnominadetalles` (`iddetalle`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION
)
ENGINE = InnoDB;

ALTER TABLE `tbltrabajadores` ADD COLUMN `estadolabora` VARCHAR(30) NOT NULL AFTER `rfcpatronorigen`;

CREATE TABLE `tblregimenfiscales` (
  `clave` INTEGER UNSIGNED NOT NULL,
  `descripcion` VARCHAR(100) NOT NULL,
  `fisica` TINYINT UNSIGNED NOT NULL,
  `moral` TINYINT UNSIGNED NOT NULL,
  PRIMARY KEY (`clave`)
)
ENGINE = InnoDB;

insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(601,'General de Ley Personas Morales',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(603,'Personas Morales con Fines no Lucrativos',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(605,'Sueldos y Salarios e Ingresos Asimilados a Salarios',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(606,'Arrendamiento',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(607,'Rgimen de Enajenacin o Adquisicin de Bienes',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(608,'Dems ingresos',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(609,'Consolidacin',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(610,'Residentes en el Extranjero sin Establecimiento Permanente en Mxico',0,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(611,'Ingresos por Dividendos (socios y accionistas)',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(612,'Personas Fsicas con Actividades Empresariales y Profesionales',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(614,'Ingresos por intereses',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(615,'Rgimen de los ingresos por obtencin de premios',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(616,'Sin obligaciones fiscales',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(620,'Sociedades Cooperativas de Produccin que optan por diferir sus ingresos',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(621,'Incorporacin Fiscal',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(622,'Actividades Agrcolas, Ganaderas, Silvcolas y Pesqueras',1,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(623,'Opcional para Grupos de Sociedades',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(624,'Coordinados',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(628,'Hidrocarburos',0,1);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(629,'De los Regmenes Fiscales Preferentes y de las Empresas Multinacionales',1,0);
insert into tblregimenfiscales(clave,descripcion,fisica,moral) values(630,'Enajenacin de acciones en bolsa de valores',1,0);

ALTER TABLE `tblsucursales` ADD COLUMN `claveregimen` INTEGER UNSIGNED NOT NULL AFTER `registropatronal`;
update tblsucursales set claveregimen=if(CHAR_LENGTH(rfc)=12,601,605);

update tblnominas set origenrecurso='NA';
ALTER TABLE `tblnominatrabajador` RENAME TO `tblnominaextra`;
ALTER TABLE `tblnominaextra` CHANGE COLUMN `idTrabajador` `idnomina` INT(10) UNSIGNED NOT NULL;
ALTER TABLE `tblnominaextra` ADD CONSTRAINT `FK_tblnominaextra_1` FOREIGN KEY `FK_tblnominaextra_1` (`idnomina`)
    REFERENCES `tblnominas` (`idnomina`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION;

ALTER TABLE `tblnominaotrospagos` MODIFY COLUMN `tipoPago` TINYINT UNSIGNED NOT NULL,
 MODIFY COLUMN `clave` VARCHAR(15) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 MODIFY COLUMN `concepto` VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;

ALTER TABLE `tblnominasubcontratacion` ADD CONSTRAINT `FK_tblnominasubcontratacion_1` FOREIGN KEY `FK_tblnominasubcontratacion_1` (`idTrabajador`)
    REFERENCES `tbltrabajadores` (`idtrabajador`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdadetallespercepciones` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdadetallespercepciones`(pIddetalle int) RETURNS varchar(2000) CHARSET utf8
BEGIN
declare varminid int;
declare varmaxid int;
declare varidinventario int;
declare varidventa int;
declare varhaynuevo int;
declare vardetalles varchar(2000);
declare varclavep varchar(5);
declare varidpercepcion int;
set varidpercepcion=(select tipo from tblnominadetalles where iddetalle=piddetalle);
set varclavep=(select clave from tblpercepciones where idpercepcion=varidpercepcion);
set vardetalles='';

if varclavep='045' then
set vardetalles=ifnull((select concat('\n Valor Mercado: ',convert(valormercado using utf8),'\n Precio al otorgarse: ',convert(precioalotorgarse using utf8)) from tblnominadetalles where iddetalle=piddetalle),0);
end if;

if varclavep='019' then
set varminid=ifnull((select min(idhoraextra) from tblnominahorasextrac where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(idhoraextra) from tblnominahorasextrac where iddetalle=piddetalle),0);
while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,ifnull((select concat('\n Dias: ',convert(dias using utf8),' Tipo Horas: ',tipohoras,' Horas Extra: ',convert(horasextra using utf8),' Importe: ',convert(importepagado using utf8)) from tblnominahorasextrac where idhoraextra=varminid limit 1),''));
set varminid=ifnull((select min(idhoraextra) from tblnominahorasextrac where iddetalle=piddetalle and idhoraextra>varminid),0);
end while;
end if;

return vardetalles;
END $$

DELIMITER ;


insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Total pagado:','septotalpagado',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Sep. Total Pagado',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Aos de servicio:','sepaniosser',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Sep. Aos Servicio',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. ltimo sueldo mensual:','sepultimosueldo',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Sep. Ult. Sueldo Mensual',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Ingreso Acumulable:','sepingacumulable',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Sep. Ing. Acumulable',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Ingreso No Acumulable:','sepingnoacumulable',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Sep. Ing. No Acumulable',0,1);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Total una exhibicin:','jubtotalunae',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Jub. Total una exh.',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Total parcialidad:','jubtotalparcialidad',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Jub. Total parcialidad.',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Monto diario:','jubmontodiario',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Jub. Monto diario.',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Ingreso Acumulable:','jubingacumulable',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Jub. Ing. Acumulable',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Ingreso No Acumulable:','jubingnoacumulable',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Jub. Ing. No Acumulable',0,1);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Origen Recurso:','sncforigen',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Ent. SNCF Origen',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Monto Recurso:','sncfmonto',700,20,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Documento - Ent. SNCF Monto',0,1);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Total pagado:','septotalpagado',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Sep. Total Pagado',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Aos de servicio:','sepaniosser',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Sep. Aos Servicio',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. ltimo sueldo mensual:','sepultimosueldo',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Sep. Ult. Sueldo Mensual',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Ingreso Acumulable:','sepingacumulable',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Sep. Ing. Acumulable',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Sep. Ingreso No Acumulable:','sepingnoacumulable',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Sep. Ing. No Acumulable',0,1);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Total una exhibicin:','jubtotalunae',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Jub. Total una exh.',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Total parcialidad:','jubtotalparcialidad',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Jub. Total parcialidad.',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Monto diario:','jubmontodiario',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Jub. Monto diario.',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Ingreso Acumulable:','jubingacumulable',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Jub. Ing. Acumulable',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Jub. Ingreso No Acumulable:','jubingnoacumulable',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Jub. Ing. No Acumulable',0,1);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Origen Recurso:','sncforigen',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Ent. SNCF Origen',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(13,643,'Monto Recurso:','sncfmonto',700,20,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Documento - Ent. SNCF Monto',0,1);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'Sindicalizado: ','sindicalizado',490,25,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Trabajador - Sindicalizado',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'RFC Patron tercero: ','rfctercero',490,25,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Trabajador - RFC Tercero',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'Estado donde labora: ','estadolabora',490,25,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Trabajador - Estado labora',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'Subcontratacin: ','subcontratacion',490,25,'Lucida Console',8,0,0,0,0,0,38,1,0,0,'Trabajador - Subcontraracin',0,3);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'Sindicalizado: ','sindicalizado',490,25,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Trabajador - Sindicalizado',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'RFC Patron tercero: ','rfctercero',490,25,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Trabajador - RFC Tercero',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'Estado donde labora: ','estadolabora',490,25,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Trabajador - Estado labora',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(45,268,'Subcontratacin: ','subcontratacion',490,25,'Lucida Console',8,0,0,0,0,0,54,1,0,0,'Trabajador - Subcontraracin',0,3);

ALTER TABLE `tblopciones2` ADD COLUMN `acteneunodos` TINYINT UNSIGNED NOT NULL AFTER `integrarbancosvp`;
update tblnominas set origenrecurso='NA';

insert into tblactualizaciones(version,versionchk) values('ver 9036 rev 14','00903614');