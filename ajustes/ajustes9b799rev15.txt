DROP TABLE IF EXISTS `tblrepmovimientosxarticulo`;
CREATE TABLE `tblrepmovimientosxarticulo` (
  `idventa` int(10) unsigned NOT NULL,
  `tipodoc` varchar(2) NOT NULL,
  `folio` varchar(45) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `nombre` varchar(450) NOT NULL,
  `cantidad` double NOT NULL,
  `preciou` double NOT NULL,
  `precio` double NOT NULL,
  `fecha` varchar(10) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `tblrepventasporsurtir` (
  `folio` INTEGER UNSIGNED NOT NULL,
  `serie` VARCHAR(45) NOT NULL,
  `fecha` VARCHAR(10) NOT NULL,
  `idcliente` INTEGER UNSIGNED NOT NULL,
  `nombre` VARCHAR(200) NOT NULL,
  `clave` VARCHAR(45) NOT NULL,
  `inombre` VARCHAR(200) NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `csurtido` DOUBLE NOT NULL,
  `tipo` VARCHAR(5) NOT NULL
)
ENGINE = InnoDB;

CREATE TABLE  `tblrepventasporsurtird` (
  `folio` int(10) unsigned NOT NULL,
  `serie` varchar(45) NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `idcliente` int(10) unsigned NOT NULL,
  `nombre` varchar(200) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `inombre` varchar(200) NOT NULL,
  `cantidad` double NOT NULL,
  `csurtido` double NOT NULL,
  `tipo` varchar(5) NOT NULL,
  `cantidadm` double NOT NULL,
  `fecham` varchar(10) NOT NULL,
  `seriem` varchar(45) NOT NULL,
  `foliom` int(10) unsigned NOT NULL,
  `idventa` int(10) unsigned NOT NULL,
  `idmovimiento` int(10) unsigned NOT NULL

) ENGINE=InnoDB DEFAULT CHARSET=utf8;


ALTER TABLE `tblclientes` ADD COLUMN `saldoafavor` DOUBLE NOT NULL AFTER `usaadenda`;
ALTER TABLE `tblinventario` ADD COLUMN `esamortizacion` TINYINT UNSIGNED NOT NULL AFTER `usaformula`,
 ADD COLUMN `peso` DOUBLE NOT NULL AFTER `esamortizacion`,
 ADD COLUMN `maximo` DOUBLE NOT NULL AFTER `peso`,
 ADD COLUMN `minimo` DOUBLE NOT NULL AFTER `maximo`;



DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavor` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavor`(pidcliente int) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente),0)+ifnull((select sum(precio*(1+iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente),0);
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavor` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavor`(pidcliente int) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente),0);
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

/* Descontar canceladas  ********************************/
/***********************************************************/


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;

ALTER TABLE `tblcomprasremisiones` ADD COLUMN `idcomprar` INTEGER UNSIGNED NOT NULL AFTER `comentario`;

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;








if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,0,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,16,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,3,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,19,1,0,0,'Peso');


DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

/*if pidsucursal<=0 then
if pidalmacen <=0 then*/
if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
/*end if;
end if;*/


return 0;


END $$

DELIMITER ;


DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then


insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;


insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,1,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,17,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,2,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,18,1,0,0,'Peso');


CREATE TABLE  `tblrepsaldoafavor` (
  `idcliente` int(10) unsigned NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `serie` varchar(45) NOT NULL,
  `folio` int(10) unsigned NOT NULL,
  `nombrec` varchar(250) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `precio` double NOT NULL,
  `iva` double NOT NULL,
  `tipo` varchar(2) NOT NULL,
  `cantidad` double NOT NULL,
  `saldoant` double NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


ALTER TABLE `tblinventariomovimientosk2` MODIFY COLUMN `serie` VARCHAR(45) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 MODIFY COLUMN `folio` VARCHAR(45) NOT NULL;



DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavorafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavorafecha`(pidcliente int,pfecha varchar(10)) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente and tblventas.fecha<pfecha),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente and tblventasremisiones.fecha<pfecha),0);
END $$

DELIMITER ;

ALTER TABLE `tblinventariomovimientosk` ADD COLUMN `folioref` VARCHAR(45) NOT NULL AFTER `idalmacen2`,
 ADD COLUMN `tiporef` VARCHAR(20) NOT NULL AFTER `folioref`;

CREATE TABLE `tblactualizaciones` (
  `version` VARCHAR(45) NOT NULL
)
ENGINE = InnoDB;



DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

/* Descontar canceladas  ********************************/
/***********************************************************/


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;








if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9009 beta 1');

delete from tblventasremisiones where usado=1 and idventar=0;

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;





/********************************************************************************/
/**********************************************************************************/
/*******************************************************************************/



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

/* Descontar canceladas  ********************************/
/***********************************************************/


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9009 beta 4');

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;





/********************************************************************************/
/**********************************************************************************/
/*******************************************************************************/



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;

update tblalmacenesi inner join tblalmacenes on tblalmacenesi.idalmacen=tblalmacenes.idalmacen set cantidad=spdainventarioafecha(idinventario,'2014/01/01',idsucursal,tblalmacenesi.idalmacen);
insert into tblactualizaciones values('ver 9009 beta 4b');

CREATE TABLE  `tbladdendaley` (
  `idaddenda` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idventa` int(10) unsigned NOT NULL,
  `clasificacion` tinyint(3) unsigned NOT NULL,
  `tipo` tinyint(3) unsigned NOT NULL,
  `proveedor` varchar(15) NOT NULL,
  `centro` varchar(15) NOT NULL,
  `numeroentrada` varchar(15) NOT NULL,
  `noremision` varchar(15) NOT NULL,
  `proveedorsap` varchar(15) NOT NULL,
  `nombreproveedor` varchar(300) NOT NULL,
  `fechaentrada` varchar(10) NOT NULL,
  `descuento` double NOT NULL,
  `pedido` varchar(15) NOT NULL,
  PRIMARY KEY (`idaddenda`),
  KEY `FK_tbladdendaley_1` (`idventa`),
  CONSTRAINT `FK_tbladdendaley_1` FOREIGN KEY (`idventa`) REFERENCES `tblventas` (`idventa`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavor` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavor`(pidcliente int) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente and tblventasremisiones.usado=0),0);
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavorafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavorafecha`(pidcliente int,pfecha varchar(10)) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente and tblventas.fecha<pfecha),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente and tblventasremisiones.fecha<pfecha and tblventasremisiones.usado=0),0);
END $$

DELIMITER ;

DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then

/* Todas sucursales todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


    else
/* Todas sucursales todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then
/* Todas sucursales un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* Todas sucursales un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then
/* una sucursal todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* una sucursal todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then
/* una sucursal un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else
/* Una sucursal un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

if pidsucursal<=0 then
/*if pidalmacen <=0 then*/
if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
else
/*Para una sola sucursal*/
if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



end if;
/*end if;*/
end if;


return 0;


END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spsacacostoarticuloafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spsacacostoarticuloafecha`(pidinventario int,pfecha1 varchar(10),ptipocosteo tinyint) RETURNS double
BEGIN
declare c int;
declare minimo int;
declare maximo int;
declare vcantidad double;
declare vprecio double;
declare vcosto double;
declare vcosto2 double;
declare vcosto3 double;
declare vinvfinal double;

if ptipocosteo=0 then
  
  delete from tblinventariosacacostos where idinventario=pidinventario;
  delete from tblinventariosacacostosm where idinventario=pidinventario;
  delete from tblinventariosacacostosr where idinventario=pidinventario;
  delete from tblinventariosacacostosf where idinventario=pidinventario;
  delete from tblinventariosacacostosf2 where idinventario=pidinventario;

  insert into tblinventariosacacostos(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasdetalles.cantidad),sum(tblcomprasdetalles.costoindirecto+(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)))  from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha<pfecha1 and tblcomprasdetalles.idinventario=pidinventario group by fecha,idinventario;
  insert into tblinventariosacacostosr(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasremisionesdetalles.cantidad),sum(if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.precio*tblcomprasremisiones.tipodecambio))  from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where tblcomprasremisiones.estado=3 and  tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.usado=0 group by fecha,idinventario;
  insert into tblinventariosacacostosm(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblmovimientosdetalles.cantidad),sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio))  from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha<pfecha1 and idinventario=pidinventario group by fecha,idinventario;


  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostos.idinventario,tblinventariosacacostos.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos left outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostos.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos right outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
 insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosr.idinventario,tblinventariosacacostosr.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr left outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosr.idinventario=pidinventario;
 insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr right outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf2(idinventario,fecha,cantidad,precio,invfinal) select idinventario,fecha,cantidad,precio,spdainventarioafecha(idinventario,f2.fecha,0,0)
   from tblinventariosacacostosf as f2 where f2.idinventario=pidinventario group by f2.fecha order by f2.fecha;

  set minimo=ifnull((select min(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set maximo=ifnull((select max(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set c=minimo;
  set vcosto=0;

  while c<=maximo do

    set vcantidad=(select cantidad from tblinventariosacacostosf2 where id=c);
    set vprecio=(select precio from tblinventariosacacostosf2 where id=c);
    set vinvfinal=(select invfinal from tblinventariosacacostosf2 where id=c);

    if vcantidad+vinvfinal>0 then
      set vcosto=(vprecio+(vinvfinal*vcosto))/(vcantidad+vinvfinal);
    else
      set vcosto=0;
    end if;

    set c=c+1;
  end while;

else
  
set vcosto=ifnull((select if(tblcomprasdetalles.idmoneda=2,max(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad+tblcomprasdetalles.costoindirecto),max(tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad)*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha<pfecha1 and tblcomprasdetalles.idinventario=pidinventario and tblcomprasdetalles.cantidad<>0),0);
set vcosto3=ifnull((select if(tblcomprasremisionesdetalles.idmoneda=2,max(tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad),max((tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad)*tblcomprasremisiones.tipodecambio)) from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where (tblcomprasremisiones.estado=3) and  tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisionesdetalles.cantidad<>0 and tblcomprasremisiones.usado=0),0);
set vcosto2=ifnull((select if(tblmovimientosdetalles.idmoneda=2,max(tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad),max((tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad)*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha<pfecha1 and idinventario=pidinventario and tblmovimientosdetalles.cantidad<>0),0);
if vcosto2>vcosto then
set vcosto=vcosto2;
end if;
if vcosto3>vcosto then
set vcosto=vcosto3;
end if;

end if;

update tblinventarioprecios inner join tblinventario on tblinventarioprecios.idinventario=tblinventario.idinventario
set tblinventarioprecios.precio=vcosto*(1+tblinventarioprecios.utilidad/100)
where tblinventarioprecios.idinventario=pidinventario and tblinventarioprecios.utilidad<>0;


return ifnull(vcosto,0);
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spsacacostoarticuloafechaa` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spsacacostoarticuloafechaa`(pidinventario int,pfecha1 varchar(10),ptipocosteo tinyint) RETURNS double
BEGIN

declare c int;
declare minimo int;
declare maximo int;
declare vcantidad double;
declare vprecio double;
declare vcosto double;
declare vcosto2 double;
declare vcosto3 double;
declare vinvfinal double;
declare varfechamax varchar(10);
declare varinvant double;
declare varidmax int;
if ptipocosteo=0 then

  delete from tblinventariosacacostos where idinventario=pidinventario;
  delete from tblinventariosacacostosm where idinventario=pidinventario;
  delete from tblinventariosacacostosr where idinventario=pidinventario;
  delete from tblinventariosacacostosf where idinventario=pidinventario;
  delete from tblinventariosacacostosf2 where idinventario=pidinventario;

  insert into tblinventariosacacostos(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasdetalles.cantidad),sum(tblcomprasdetalles.costoindirecto+(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)))  from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha=pfecha1 and tblcomprasdetalles.idinventario=pidinventario group by fecha,idinventario;
  insert into tblinventariosacacostosr(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasremisionesdetalles.cantidad),sum(if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.precio*tblcomprasremisiones.tipodecambio))  from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where tblcomprasremisiones.estado=3 and  tblcomprasremisiones.fecha=pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.usado=0 group by fecha,idinventario;
  insert into tblinventariosacacostosm(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblmovimientosdetalles.cantidad),sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio))  from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha=pfecha1 and idinventario=pidinventario group by fecha,idinventario;


  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostos.idinventario,tblinventariosacacostos.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos left outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostos.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos right outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosr.idinventario,tblinventariosacacostosr.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr left outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosr.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr right outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf2(idinventario,fecha,cantidad,precio,invfinal) select idinventario,fecha,cantidad,precio,spdainventarioafecha(idinventario,f2.fecha,0,0)
   from tblinventariosacacostosf as f2 where f2.idinventario=pidinventario group by f2.fecha order by f2.fecha;

  set minimo=ifnull((select min(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set maximo=ifnull((select max(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set c=minimo;
  /*set vcosto=0;*/
  /*set varidmax=ifnull((select max(fecha) from tblinventariocostohex where idinventario=pidinventario and fecha<pfecha1),0);*/
  set varfechamax=ifnull((select max(fecha) from tblinventariocostohex where fecha<pfecha1),'1900/01/01');
  /*set varfechamax=(select fecha from tblinventarioultimo);*/
  set vcosto=ifnull((select costo from tblinventariocostohex where fecha=varfechamax limit 1),0);
  /*insert into tbldebug values(pidinventario,pfecha1,vcosto,varfechamax,0,0,0,0,0,0,c);*/
  while c<=maximo do

    set vcantidad=(select cantidad from tblinventariosacacostosf2 where id=c);
    set vprecio=(select precio from tblinventariosacacostosf2 where id=c);
    set vinvfinal=(select invfinal from tblinventariosacacostosf2 where id=c);
    if vcantidad+vinvfinal>0 then
      set vcosto=(vprecio+(vinvfinal*vcosto))/(vcantidad+vinvfinal);
    else
      set vcosto=0;
    end if;

    set c=c+1;
     /*insert into tbldebug values(pidinventario,pfecha1,vcosto,varfechamax,vcantidad,vprecio,vinvfinal,1,vprecio+(vinvfinal*vcosto),vcantidad+vinvfinal,c);*/
  end while;
/*    update tblinventarioultimo set fecha=pfecha1;*/
    insert into tblinventariocostohex(idinventario,fecha,costo) values(pidinventario,pfecha1,vcosto);
else

set vcosto=ifnull((select if(tblcomprasdetalles.idmoneda=2,max(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad+tblcomprasdetalles.costoindirecto),max(tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad)*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha<=pfecha1 and tblcomprasdetalles.idinventario=pidinventario and tblcomprasdetalles.cantidad<>0),0);
set vcosto3=ifnull((select if(tblcomprasremisionesdetalles.idmoneda=2,max(tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad),max((tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad)*tblcomprasremisiones.tipodecambio)) from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where (tblcomprasremisiones.estado=3) and  tblcomprasremisiones.fecha<=pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisionesdetalles.cantidad<>0 and tblcomprasremisiones.usado=0),0);
set vcosto2=ifnull((select if(tblmovimientosdetalles.idmoneda=2,max(tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad),max((tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad)*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha<=pfecha1 and idinventario=pidinventario and tblmovimientosdetalles.cantidad<>0),0);
if vcosto2>vcosto then
set vcosto=vcosto2;
end if;
if vcosto3>vcosto then
set vcosto=vcosto3;
end if;

end if;

update tblinventarioprecios inner join tblinventario on tblinventarioprecios.idinventario=tblinventario.idinventario
set tblinventarioprecios.precio=vcosto*(1+tblinventarioprecios.utilidad/100)
where tblinventarioprecios.idinventario=pidinventario and tblinventarioprecios.utilidad<>0;

return ifnull(vcosto,0);



END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9009 beta 5');

ALTER TABLE `tblcajas` ADD COLUMN `serie` VARCHAR(20) NOT NULL AFTER `idsucursal`;
ALTER TABLE `tblcajas` ADD COLUMN `deposito` DOUBLE NOT NULL AFTER `serie`;
ALTER TABLE `tblcajas` ADD COLUMN `seriecot` VARCHAR(20) NOT NULL AFTER `deposito`,
 ADD COLUMN `serieped` VARCHAR(20) NOT NULL AFTER `seriecot`;
insert into tblactualizaciones values('ver 9010 beta 1');


DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then

/* Todas sucursales todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


    else
/* Todas sucursales todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then
/* Todas sucursales un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* Todas sucursales un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then
/* una sucursal todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* una sucursal todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblventas.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then
/* una sucursal un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else
/* Una sucursal un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

if pidsucursal<=0 then

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
else

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



end if;

end if;


return 0;


END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9010 beta 3');

delete from tblimpresionesnodos where documento=32 and idsucursal=1;
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(15,763,'OTORGANTE:','nombrefiscal',500,20,'Microsoft Sans Serif',7,0,0,0,0,0,32,1,0,1,'Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(259,27,'Calle - Empresa','direccion',220,20,'Arial',9,0,0,0,0,0,32,1,0,0,'Calle - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(437,27,'No:','noexterior',100,20,'Arial',9,0,0,0,0,0,32,1,0,1,'No. Exterior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(654,11,'No. Interior - Empresa','nointerior',220,20,'Lucida Console',8,0,0,0,0,0,32,1,0,0,'No. Interior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(210,11,'Col:','colonia',160,20,'Arial',10,0,0,0,0,0,32,1,0,1,'Colonia- Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(79,12,'Ciudad - Empresa','ciudad',160,20,'Arial',10,0,0,0,0,0,32,1,0,0,'Ciudad - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(60,5,'ESTADO','estado',100,20,'Arial',10,0,0,0,0,0,32,1,0,1,'Estado - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(259,59,'C.P.','cp',80,20,'Arial',9,0,0,0,0,0,32,1,0,1,'CP - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'R.F.C.','rfc',200,20,'Arial',9,0,0,0,0,0,32,1,0,1,'RFC - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(259,76,'TELS./FAX:','tel',300,20,'Arial',9,0,0,0,0,0,32,1,0,1,'Telefono - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(196,15,'Email - Empresa','email',400,20,'Arial',10,0,0,0,0,0,32,1,0,0,'Email - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(750,17,'Referencia - Empresa','referencia',200,20,'Lucida Console',8,0,0,0,0,0,32,1,0,0,'Referencia - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(680,30,'Serie','serie',50,20,'Arial',10,0,0,0,0,1,32,1,0,0,'Serie');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(707,30,'Folio','folio',100,20,'Arial',10,0,0,0,0,1,32,1,0,0,'Folio');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(690,108,'Fecha','fecha',100,20,'Arial',10,0,0,0,0,1,32,1,0,0,'Fecha');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(559,30,'Hora','hora',100,20,'Arial',10,0,0,0,0,0,32,1,0,0,'Hora');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(24,275,'Descripcin','descripcion',700,200,'Lucida Console',8,0,0,1,0,1,32,1,0,0,'Descripcin');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(713,279,'Importe','importe',120,20,'Lucida Console',8,0,0,1,1,1,32,1,0,0,'Importe');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,1,32,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(723,749,'Total:','total',120,20,'Lucida Console',8,0,0,0,1,1,32,1,0,0,'Total');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,703,'Total letra','totalletra',500,50,'Lucida Console',8,0,0,0,0,1,32,1,0,0,'Total letra');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(262,88,'Municipio empresa','municipio',136,20,'Arial',8,0,0,0,0,0,32,1,0,0,'Municipio Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(159,888,'Total','total',120,16,'Lucida Console',8,0,0,0,1,0,32,1,0,1,'Total2');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,328,'Tipo','tipocantidad',32,20,'Lucida Console',8,0,0,0,0,0,32,1,0,0,'Tipo Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(182,909,'Total letra 2','totalletra',650,20,'Microsoft Sans Serif',7,0,0,0,0,0,32,1,0,0,'Total Letra 2');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(184,923,'Fecha 2','fecha',120,16,'Lucida Console',8,0,0,0,0,0,32,1,0,0,'Fecha02');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,1078,'No: ','serie',60,16,'Lucida Console',8,0,0,0,0,0,32,1,0,1,'Serie02');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(30,1078,'Folio02','folio',58,16,'Lucida Console',8,0,0,0,0,0,32,1,0,0,'Folio02');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(29,21,'Calle - Empresa','direccion',220,20,'Arial',9,0,0,0,0,0,32,1,0,0,'Calle2 - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(12,125,'Vendedor:','vendedor',160,20,'Lucida Console',8,0,0,0,0,1,32,1,0,0,'Vendedor');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(324,492,'Mensaje Candelado','cancelado',170,20,'Arial',18,0,0,1,0,1,32,1,0,0,'Mensaje Candelado');

delete from tblimpresionesnodos where documento=48 and idsucursal=1;
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(15,763,'OTORGANTE:','nombrefiscal',500,20,'Microsoft Sans Serif',7,0,0,0,0,0,48,1,0,1,'Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(259,27,'Calle - Empresa','direccion',220,20,'Arial',9,0,0,0,0,0,48,1,0,0,'Calle - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(437,27,'No:','noexterior',100,20,'Arial',9,0,0,0,0,0,48,1,0,1,'No. Exterior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(654,11,'No. Interior - Empresa','nointerior',220,20,'Lucida Console',8,0,0,0,0,0,48,1,0,0,'No. Interior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(210,11,'Col:','colonia',160,20,'Arial',10,0,0,0,0,0,48,1,0,1,'Colonia- Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(79,12,'Ciudad - Empresa','ciudad',160,20,'Arial',10,0,0,0,0,0,48,1,0,0,'Ciudad - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(60,5,'ESTADO','estado',100,20,'Arial',10,0,0,0,0,0,48,1,0,1,'Estado - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(259,59,'C.P.','cp',80,20,'Arial',9,0,0,0,0,0,48,1,0,1,'CP - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'R.F.C.','rfc',200,20,'Arial',9,0,0,0,0,0,48,1,0,1,'RFC - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(259,76,'TELS./FAX:','tel',300,20,'Arial',9,0,0,0,0,0,48,1,0,1,'Telefono - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(196,15,'Email - Empresa','email',400,20,'Arial',10,0,0,0,0,0,48,1,0,0,'Email - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(750,17,'Referencia - Empresa','referencia',200,20,'Lucida Console',8,0,0,0,0,0,48,1,0,0,'Referencia - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(680,30,'Serie','serie',50,20,'Arial',10,0,0,0,0,1,48,1,0,0,'Serie');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(707,30,'Folio','folio',100,20,'Arial',10,0,0,0,0,1,48,1,0,0,'Folio');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(690,108,'Fecha','fecha',100,20,'Arial',10,0,0,0,0,1,48,1,0,0,'Fecha');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(559,30,'Hora','hora',100,20,'Arial',10,0,0,0,0,0,48,1,0,0,'Hora');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(24,275,'Descripcin','descripcion',700,200,'Lucida Console',8,0,0,1,0,1,48,1,0,0,'Descripcin');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(713,279,'Importe','importe',120,20,'Lucida Console',8,0,0,1,1,1,48,1,0,0,'Importe');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,1,48,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(723,749,'Total:','total',120,20,'Lucida Console',8,0,0,0,1,1,48,1,0,0,'Total');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,703,'Total letra','totalletra',500,50,'Lucida Console',8,0,0,0,0,1,48,1,0,0,'Total letra');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(262,88,'Municipio empresa','municipio',136,20,'Arial',8,0,0,0,0,0,48,1,0,0,'Municipio Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(159,888,'Total','total',120,16,'Lucida Console',8,0,0,0,1,0,48,1,0,1,'Total2');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,328,'Tipo','tipocantidad',32,20,'Lucida Console',8,0,0,0,0,0,48,1,0,0,'Tipo Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(182,909,'Total letra 2','totalletra',650,20,'Microsoft Sans Serif',7,0,0,0,0,0,48,1,0,0,'Total Letra 2');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(184,923,'Fecha 2','fecha',120,16,'Lucida Console',8,0,0,0,0,0,48,1,0,0,'Fecha02');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,1078,'No: ','serie',60,16,'Lucida Console',8,0,0,0,0,0,48,1,0,1,'Serie02');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(30,1078,'Folio02','folio',58,16,'Lucida Console',8,0,0,0,0,0,48,1,0,0,'Folio02');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(29,21,'Calle - Empresa','direccion',220,20,'Arial',9,0,0,0,0,0,48,1,0,0,'Calle2 - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(12,125,'Vendedor:','vendedor',160,20,'Lucida Console',8,0,0,0,0,1,48,1,0,0,'Vendedor');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(324,492,'Mensaje Candelado','cancelado',170,20,'Arial',18,0,0,1,0,1,48,1,0,0,'Mensaje Candelado');

insert into tblimpresiones(y,yl,documento,idsucursal,rg,alt,modo,ancho) values(270,350,32,1,20,3,0,864);
insert into tblimpresiones(y,yl,documento,idsucursal,rg,alt,modo,ancho) values(270,350,48,1,20,3,0,864);

CREATE TABLE `tblcajasmovimientos` (
  `idmovimiento` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `fecha` VARCHAR(10) NOT NULL,
  `folio` INTEGER UNSIGNED NOT NULL,
  `total` DOUBLE NOT NULL,
  `hora` VARCHAR(8) NOT NULL,
  `estado` TINYINT UNSIGNED NOT NULL,
  `iva` DOUBLE NOT NULL,
  `totalapagar` DOUBLE NOT NULL,
  `desglosar` TINYINT UNSIGNED NOT NULL,
  `idsucursal` INTEGER UNSIGNED NOT NULL,
  `serie` VARCHAR(45) NOT NULL,
  `idcaja` INTEGER UNSIGNED NOT NULL,
  `usado` TINYINT UNSIGNED NOT NULL,
  `idvendedor` INTEGER UNSIGNED NOT NULL,
  `comentario` VARCHAR(2000) NOT NULL,
  `tipo` TINYINT UNSIGNED NOT NULL,
  PRIMARY KEY (`idmovimiento`)
)
ENGINE = InnoDB;

CREATE TABLE `tblcajasmovimientosdetalles` (
  `iddetalle` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `idmovimiento` INTEGER UNSIGNED NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `precio` DOUBLE NOT NULL,
  `descripcion` VARCHAR(2000) NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `iva` DOUBLE NOT NULL,
  `extra` VARCHAR(45) NOT NULL,
  `descuento` DOUBLE NOT NULL,
  PRIMARY KEY (`iddetalle`)
)
ENGINE = InnoDB;


ALTER TABLE `tblcajasmovimientos` ADD CONSTRAINT `FK_tblcajasmovimientos_1` FOREIGN KEY `FK_tblcajasmovimientos_1` (`idcaja`)
    REFERENCES `tblcajas` (`idcaja`)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION,
 ADD CONSTRAINT `FK_tblcajasmovimientos_2` FOREIGN KEY `FK_tblcajasmovimientos_2` (`idvendedor`)
    REFERENCES `tblvendedores` (`idvendedor`)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION,
 ADD CONSTRAINT `FK_tblcajasmovimientos_3` FOREIGN KEY `FK_tblcajasmovimientos_3` (`idsucursal`)
    REFERENCES `tblsucursales` (`idsucursal`)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION;

ALTER TABLE `tblcajasmovimientosdetalles` ADD CONSTRAINT `FK_tblcajasmovimientosdetalles_1` FOREIGN KEY `FK_tblcajasmovimientosdetalles_1` (`idmovimiento`)
    REFERENCES `tblcajasmovimientos` (`idmovimiento`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION;

update tblimpresionesnodos set datapropertyname='tipo',nombre='Tipo',tiponodo=0 where (documento=32 or documento=48) and datapropertyname='tipocantidad';

insert into tblactualizaciones values('ver 9010 beta 5');


ALTER TABLE `tblventas` ADD COLUMN `deremision` BIT NOT NULL AFTER `porsurtir`;
ALTER TABLE `tblcompras` ADD COLUMN `deremision` BIT NOT NULL AFTER `comentario`;

update tblcompras set deremision=1 where (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)<>0;
update tblventas set deremision=1 where (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)<>0;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

/* Descontar canceladas  ********************************/
/***********************************************************/


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;


ALTER TABLE `tblproveedoresviejossaldos` ADD COLUMN `tipodecambio` DOUBLE NOT NULL AFTER `tipo`,
 ADD COLUMN `corriente` DOUBLE NOT NULL AFTER `tipodecambio`;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafechaproveedor` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafechaproveedor`(pidproveedor int,pfecha varchar(10)) RETURNS double
BEGIN
declare varsaldo double;

set varsaldo=(select ifnull((select sum(if(idmoneda=2,totalapagar,totalapagar*tipodecambio)) from tblcompras inner join tblformasdepago on tblcompras.idforma=tblformasdepago.idforma where tblformasdepago.tipo=0 and idproveedor=pidproveedor and fecha<pfecha and estado=3),0));
set varsaldo=varsaldo+(select ifnull((select sum(if(idmoneda=2,totalapagar,totalapagar*tipodecambio)) from tblnotasdecargocompras where idproveedor=pidproveedor and fecha<pfecha and estado=3),0));
set varsaldo=varsaldo+(select ifnull((select sum(if(idmoneda=2,totalapagar,totalapagar*tipodecambio)) from tbldocumentosproveedores where idproveedor=pidproveedor and fecha<pfecha and estado=3),0));
set varsaldo=varsaldo-(select ifnull((select sum(if(idmoneda=2,cantidad,cantidad*ptipodecambio)) from tblcompraspagos where idproveedor=pidproveedor and tblcompraspagos.estado=3 and tblcompraspagos.fecha<pfecha),0));
Return varsaldo;

END $$

DELIMITER ;

ALTER TABLE `tblproveedoresviejossaldos` ADD COLUMN `totalapagar` DOUBLE NOT NULL AFTER `corriente`;

ALTER TABLE `tblclientesviejossaldos` ADD COLUMN `tipodecambio` DOUBLE NOT NULL AFTER `tipo`,
 ADD COLUMN `corriente` DOUBLE NOT NULL AFTER `tipodecambio`,
 ADD COLUMN `totalapagar` DOUBLE NOT NULL AFTER `corriente`;


insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,0,1,0,1,'Total Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,16,1,0,1,'Total Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,1,1,0,1,'Total Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,17,1,0,1,'Total Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,2,1,0,1,'Total Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,18,1,0,1,'Total Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,3,1,0,1,'Total Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,19,1,0,1,'Total Cantidad');

insert into tblactualizaciones values('ver 9011 beta 1');


CREATE TABLE `tblrepcajasmovimientos` (
  `idmovimiento` INTEGER UNSIGNED NOT NULL,
  `fecha` VARCHAR(10) NOT NULL,
  `folio` INTEGER UNSIGNED NOT NULL,
  `serie` VARCHAR(20) NOT NULL,
  `estado` TINYINT UNSIGNED NOT NULL,
  `descripcion` VARCHAR(2000) NOT NULL,
  `precio` DOUBLE NOT NULL,
  `tipo` TINYINT UNSIGNED NOT NULL,
  `idcaja` INTEGER UNSIGNED NOT NULL,
  `nombre` VARCHAR(150) NOT NULL
)
ENGINE = InnoDB;


DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then

/* Todas sucursales todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


    else
/* Todas sucursales todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then
/* Todas sucursales un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* Todas sucursales un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then
/* una sucursal todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* una sucursal todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then
/* una sucursal un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else
/* Una sucursal un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

if pidsucursal<=0 then

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
else

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



end if;

end if;


return 0;


END $$

DELIMITER ;

CREATE TABLE `tblventasapartados` (
  `idapartado` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `fecha` VARCHAR(10) NOT NULL,
  `estado` TINYINT UNSIGNED NOT NULL,
  `idsucursal` INTEGER UNSIGNED NOT NULL,
  `folio` INTEGER UNSIGNED NOT NULL,
  `serie` VARCHAR(20) NOT NULL,
  `prioridad` TINYINT UNSIGNED NOT NULL,
  `idcliente` INTEGER UNSIGNED NOT NULL,
  `comentario` VARCHAR(2000) NOT NULL,
  `prioridadstr` VARCHAR(150) NOT NULL,
  `fechasalida` VARCHAR(10) NOT NULL,
  `horasalida` VARCHAR(6) NOT NULL,
  `hora` VARCHAR(6) NOT NULL,
  `fechacancelado` VARCHAR(10) NOT NULL,
  `horacancelado` VARCHAR(6) NOT NULL,
  `totalapagar` DOUBLE NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `credito` DOUBLE NOT NULL,
  `tipodecambio` DOUBLE NOT NULL,
  `idvendedor` INTEGER UNSIGNED NOT NULL,
  `surtido` INTEGER UNSIGNED NOT NULL,
  `surtidodonde` TINYINT UNSIGNED NOT NULL,
  PRIMARY KEY (`idapartado`)
)
ENGINE = InnoDB;

CREATE TABLE `tblventasapartadosdetalles` (
  `iddetalle` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `precio` DOUBLE NOT NULL,
  `idinventario` INTEGER UNSIGNED NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `idapartado` INTEGER UNSIGNED NOT NULL,
  `descripcion` VARCHAR(2000) NOT NULL,
  `idalmacen` INTEGER UNSIGNED NOT NULL,
  `iva` DOUBLE NOT NULL,
  `extra` VARCHAR(45) NOT NULL,
  `descuento` DOUBLE NOT NULL,
  `surtido` DOUBLE NOT NULL,
  PRIMARY KEY (`iddetalle`),
  CONSTRAINT `FK_tblventasapartadosdetalles_1` FOREIGN KEY `FK_tblventasapartadosdetalles_1` (`idapartado`)
    REFERENCES `tblventasapartados` (`idapartado`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION,
  CONSTRAINT `FK_tblventasapartadosdetalles_2` FOREIGN KEY `FK_tblventasapartadosdetalles_2` (`idinventario`)
    REFERENCES `tblinventario` (`idinventario`)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION,
  CONSTRAINT `FK_tblventasapartadosdetalles_3` FOREIGN KEY `FK_tblventasapartadosdetalles_3` (`idalmacen`)
    REFERENCES `tblalmacenes` (`idalmacen`)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION
)
ENGINE = InnoDB;

CREATE TABLE `tblventaspagosapartados` (
  `idpago` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `cantidad` DOUBLE NOT NULL,
  `estado` TINYINT UNSIGNED NOT NULL,
  `idremision` INTEGER UNSIGNED NOT NULL,
  `fecha` VARCHAR(10) NOT NULL,
  `tipo` TINYINT UNSIGNED NOT NULL,
  `hora` VARCHAR(6) NOT NULL,
  `fechacancelado` VARCHAR(10) NOT NULL,
  `horacancelado` VARCHAR(6) NOT NULL,
  `idcliente` INTEGER UNSIGNED NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `ptipodecambio` DOUBLE NOT NULL,
  `idconceptonotaventa` INTEGER UNSIGNED NOT NULL,
  PRIMARY KEY (`idpago`)
)
ENGINE = InnoDB;

ALTER TABLE `tblventasapartados` ADD COLUMN `dinventario` TINYINT UNSIGNED NOT NULL AFTER `surtidodonde`;


insert into tblactualizaciones values('ver 9012 rev 3');

DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

if pidsucursal<=0 then

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
else

if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



end if;

end if;


return 0;


END $$

DELIMITER ;

CREATE TABLE `tblventasapartados` (
  `idapartado` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `fecha` VARCHAR(10) NOT NULL,
  `estado` TINYINT UNSIGNED NOT NULL,
  `idsucursal` INTEGER UNSIGNED NOT NULL,
  `folio` INTEGER UNSIGNED NOT NULL,
  `serie` VARCHAR(20) NOT NULL,
  `prioridad` TINYINT UNSIGNED NOT NULL,
  `idcliente` INTEGER UNSIGNED NOT NULL,
  `comentario` VARCHAR(2000) NOT NULL,
  `prioridadstr` VARCHAR(150) NOT NULL,
  `fechasalida` VARCHAR(10) NOT NULL,
  `horasalida` VARCHAR(8) NOT NULL,
  `hora` VARCHAR(8) NOT NULL,
  `fechacancelado` VARCHAR(10) NOT NULL,
  `horacancelado` VARCHAR(8) NOT NULL,
  `totalapagar` DOUBLE NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `credito` DOUBLE NOT NULL,
  `tipodecambio` DOUBLE NOT NULL,
  `idvendedor` INTEGER UNSIGNED NOT NULL,
  `surtido` INTEGER UNSIGNED NOT NULL,
  `surtidodonde` TINYINT UNSIGNED NOT NULL,
  PRIMARY KEY (`idapartado`)
)
ENGINE = InnoDB;

CREATE TABLE `tblventasapartadosdetalles` (
  `iddetalle` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `precio` DOUBLE NOT NULL,
  `idinventario` INTEGER UNSIGNED NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `idapartado` INTEGER UNSIGNED NOT NULL,
  `descripcion` VARCHAR(2000) NOT NULL,
  `idalmacen` INTEGER UNSIGNED NOT NULL,
  `iva` DOUBLE NOT NULL,
  `extra` VARCHAR(45) NOT NULL,
  `descuento` DOUBLE NOT NULL,
  `surtido` DOUBLE NOT NULL,
  PRIMARY KEY (`iddetalle`),
  CONSTRAINT `FK_tblventasapartadosdetalles_1` FOREIGN KEY `FK_tblventasapartadosdetalles_1` (`idapartado`)
    REFERENCES `tblventasapartados` (`idapartado`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION,
  CONSTRAINT `FK_tblventasapartadosdetalles_2` FOREIGN KEY `FK_tblventasapartadosdetalles_2` (`idinventario`)
    REFERENCES `tblinventario` (`idinventario`)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION,
  CONSTRAINT `FK_tblventasapartadosdetalles_3` FOREIGN KEY `FK_tblventasapartadosdetalles_3` (`idalmacen`)
    REFERENCES `tblalmacenes` (`idalmacen`)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION
)
ENGINE = InnoDB;

CREATE TABLE `tblventaspagosapartados` (
  `idpago` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `cantidad` DOUBLE NOT NULL,
  `estado` TINYINT UNSIGNED NOT NULL,
  `idremision` INTEGER UNSIGNED NOT NULL,
  `fecha` VARCHAR(10) NOT NULL,
  `tipo` TINYINT UNSIGNED NOT NULL,
  `hora` VARCHAR(8) NOT NULL,
  `fechacancelado` VARCHAR(10) NOT NULL,
  `horacancelado` VARCHAR(8) NOT NULL,
  `idcliente` INTEGER UNSIGNED NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `ptipodecambio` DOUBLE NOT NULL,
  `idconceptonotaventa` INTEGER UNSIGNED NOT NULL,
  PRIMARY KEY (`idpago`)
)
ENGINE = InnoDB;

ALTER TABLE `tblventasapartados` ADD COLUMN `dinventario` TINYINT UNSIGNED NOT NULL AFTER `surtidodonde`;
update tblopciones set noexteriorlocal='0';

ALTER TABLE `tblventaspagosapartados` MODIFY COLUMN `tipo` VARCHAR(2000) NOT NULL;

delete from tblimpresionesnodos where documento=33 and idsucursal=1;
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,10,'Empresa','nombrefiscal',500,20,'Arial',10,1,0,0,0,1,33,1,0,0,'Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,31,'Calle - Empresa','direccion',150,20,'Arial',10,0,0,0,0,1,33,1,0,0,'Calle - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(397,31,'No. Exterior - Empresa','noexterior',220,20,'Arial',10,0,0,0,0,1,33,1,0,0,'No. Exterior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(622,7,'No. Interior - Empresa','nointerior',220,20,'Lucida Console',8,0,0,0,0,0,33,1,0,0,'No. Interior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,52,'Col:','colonia',160,20,'Arial',10,0,0,0,0,1,33,1,0,1,'Colonia- Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(407,52,'Ciudad - Empresa','ciudad',160,20,'Arial',10,0,0,0,0,1,33,1,0,0,'Ciudad - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,52,'Estado - Empresa','estado',160,20,'Arial',10,0,0,0,0,1,33,1,0,0,'Estado - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,72,'C.P:','cp',80,20,'Arial',10,0,0,0,0,1,33,1,0,1,'CP - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(327,72,'RFC:','rfc',130,20,'Arial',10,0,0,0,0,1,33,1,0,1,'RFC - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(458,72,'Tel:','tel',180,20,'Arial',10,0,0,0,0,1,33,1,0,1,'Telefono - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,93,'Email - Empresa','email',400,20,'Arial',10,0,0,0,0,1,33,1,0,0,'Email - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(624,31,'Referencia - Empresa','referencia',200,20,'Lucida Console',8,0,0,0,0,0,33,1,0,0,'Referencia - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,163,'Cliente: ','nombrecliente',460,25,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Nombre Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,185,'Calle:','direccioncliente',350,20,'Lucida Console',8,0,0,0,0,1,33,1,0,1,'Calle - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(365,185,'No:','noexteriorcliente',150,20,'Lucida Console',8,0,0,0,0,1,33,1,0,1,'No. Exterior - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(84,95,'No Int:','nointeriorcliente',150,20,'Lucida Console',8,0,0,0,0,0,33,1,0,0,'No. Interior - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,200,'Colonia:','coloniacliente',230,20,'Lucida Console',8,0,0,0,0,1,33,1,0,1,'Colonia - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(245,200,'CP:','cpcliente',120,20,'Lucida Console',8,0,0,0,0,1,33,1,0,1,'CP - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(19,237,'Ciudad:','ciudadcliente',140,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Ciudad - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(156,217,'Estado:','estadocliente',160,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Estado - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(360,217,'RFC:','rfccliente',150,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'RFC - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(662,117,'Serie','serie',50,20,'Arial',8,0,0,0,0,1,33,1,0,0,'Serie');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(713,117,'Folio','folio',100,20,'Arial',8,0,0,0,0,1,33,1,0,0,'Folio');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(663,141,'Fecha','fecha',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,33,1,0,0,'Fecha');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(764,141,'Hora','hora',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,33,1,0,0,'Hora');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,273,'Clave','clave',100,20,'Lucida Console',8,0,0,1,0,1,33,1,0,0,'Clave');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(116,273,'Descripcin','descripcion',360,290,'Lucida Console',8,0,0,1,0,1,33,1,0,0,'Descripcin');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(484,273,'Cantidad','cantidad',90,20,'Lucida Console',8,0,0,1,1,1,33,1,0,0,'Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(609,273,'Precio Unitario','preciou',120,20,'Lucida Console',8,0,0,1,1,1,33,1,0,0,'Precio Unitario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,273,'Importe','importe',120,20,'Lucida Console',8,0,0,1,1,1,33,1,0,0,'Importe');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,681,'Subtotal','subtotal',120,20,'Lucida Console',8,0,0,0,1,1,33,1,0,1,'Subtotal');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,700,'Iva','iva',120,20,'Lucida Console',8,0,0,0,1,1,33,1,0,1,'Iva');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,732,'Total','total',120,20,'Lucida Console',8,0,0,0,1,1,33,1,0,1,'Total');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(19,696,'Total letra','totalletra',600,50,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Total letra');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(24,108,'Clave cliente','clavecliente',120,20,'Arial',8,0,0,0,0,0,33,1,0,0,'Clave Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(34,73,'Municipio cliente','municipiocliente',136,20,'Arial',8,0,0,0,0,0,33,1,0,0,'Municipio Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(101,22,'Municipio empresa','municipio',136,20,'Arial',8,0,0,0,0,0,33,1,0,0,'Municipio Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(562,273,'Tipo','tipocantidad',32,20,'Lucida Console',8,0,0,1,0,1,33,1,0,0,'Tipo Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(10,10,'CURP','curpcliente',120,20,'Lucida Console',8,0,0,0,0,0,33,1,0,0,'CURP Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,51,'Contacto:','contactocliente',160,20,'Lucida Console',8,0,0,0,0,0,33,1,0,0,'Contacto Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,51,'Referencia:','refcliente',160,20,'Lucida Console',8,0,0,0,0,0,33,1,0,0,'Ref. Dom. Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'% Descuento','descuentopor',120,25,'Lucida Console',8,1,0,1,1,0,33,1,0,0,'% Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Cant. Descuento','descuentocant',120,25,'Lucida Console',8,1,0,1,1,0,33,1,0,0,'Cant. Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Precio s/desc','preciosindesc',120,25,'Lucida Console',8,1,0,1,1,1,33,1,0,0,'Precio s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Importe+Iva','importeiva',120,25,'Lucida Console',8,1,0,1,0,0,33,1,0,0,'Importe + IVA');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Preciou+Iva','preciouiva',120,25,'Lucida Console',8,1,0,1,0,0,33,1,0,0,'PrecioU + IVA');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(12,136,'Vendedor:','vendedor',160,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Vendedor');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(179,132,'Prioridad Mensaje:','prioridadstr',300,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Prioridad Mensaje');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(324,492,'Mensaje Candelado','cancelado',170,20,'Arial',18,0,0,1,0,1,33,1,0,0,'Mensaje Candelado');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,642,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,1,33,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,1,33,1,0,1,'Total Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(179,132,'Prioridad:','prioridad',300,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Prioridad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,673,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(663,141,'Fecha salida:','fechasalida',100,20,'Lucida Console',10,0,0,0,0,1,33,1,0,0,'Fecha Salida');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(764,141,'Hora salida:','horasalida',100,20,'Lucida Console',10,0,0,0,0,1,33,1,0,0,'Hora Salida');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,642,'Surtido:','surtido',700,20,'Lucida Console',8,0,0,0,0,1,33,1,0,0,'Surtido');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,33,1,0,1,'Total Cantidad');

delete from tblimpresionesnodos where documento=49 and idsucursal=1;
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,10,'Empresa','nombrefiscal',500,20,'Arial',10,1,0,0,0,1,49,1,0,0,'Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,31,'Calle - Empresa','direccion',150,20,'Arial',10,0,0,0,0,1,49,1,0,0,'Calle - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(397,31,'No. Exterior - Empresa','noexterior',220,20,'Arial',10,0,0,0,0,1,49,1,0,0,'No. Exterior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(622,7,'No. Interior - Empresa','nointerior',220,20,'Lucida Console',8,0,0,0,0,0,49,1,0,0,'No. Interior - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,52,'Col:','colonia',160,20,'Arial',10,0,0,0,0,1,49,1,0,1,'Colonia- Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(407,52,'Ciudad - Empresa','ciudad',160,20,'Arial',10,0,0,0,0,1,49,1,0,0,'Ciudad - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,52,'Estado - Empresa','estado',160,20,'Arial',10,0,0,0,0,1,49,1,0,0,'Estado - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,72,'C.P:','cp',80,20,'Arial',10,0,0,0,0,1,49,1,0,1,'CP - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(327,72,'RFC:','rfc',130,20,'Arial',10,0,0,0,0,1,49,1,0,1,'RFC - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(458,72,'Tel:','tel',180,20,'Arial',10,0,0,0,0,1,49,1,0,1,'Telefono - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(246,93,'Email - Empresa','email',400,20,'Arial',10,0,0,0,0,1,49,1,0,0,'Email - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(624,31,'Referencia - Empresa','referencia',200,20,'Lucida Console',8,0,0,0,0,0,49,1,0,0,'Referencia - Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,163,'Cliente: ','nombrecliente',460,25,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Nombre Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,185,'Calle:','direccioncliente',350,20,'Lucida Console',8,0,0,0,0,1,49,1,0,1,'Calle - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(365,185,'No:','noexteriorcliente',150,20,'Lucida Console',8,0,0,0,0,1,49,1,0,1,'No. Exterior - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(84,95,'No Int:','nointeriorcliente',150,20,'Lucida Console',8,0,0,0,0,0,49,1,0,0,'No. Interior - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,200,'Colonia:','coloniacliente',230,20,'Lucida Console',8,0,0,0,0,1,49,1,0,1,'Colonia - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(245,200,'CP:','cpcliente',120,20,'Lucida Console',8,0,0,0,0,1,49,1,0,1,'CP - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(19,237,'Ciudad:','ciudadcliente',140,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Ciudad - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(156,217,'Estado:','estadocliente',160,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Estado - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(360,217,'RFC:','rfccliente',150,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'RFC - Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(662,117,'Serie','serie',50,20,'Arial',8,0,0,0,0,1,49,1,0,0,'Serie');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(713,117,'Folio','folio',100,20,'Arial',8,0,0,0,0,1,49,1,0,0,'Folio');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(663,141,'Fecha','fecha',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,49,1,0,0,'Fecha');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(764,141,'Hora','hora',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,49,1,0,0,'Hora');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,273,'Clave','clave',100,20,'Lucida Console',8,0,0,1,0,1,49,1,0,0,'Clave');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(116,273,'Descripcin','descripcion',360,290,'Lucida Console',8,0,0,1,0,1,49,1,0,0,'Descripcin');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(484,273,'Cantidad','cantidad',90,20,'Lucida Console',8,0,0,1,1,1,49,1,0,0,'Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(609,273,'Precio Unitario','preciou',120,20,'Lucida Console',8,0,0,1,1,1,49,1,0,0,'Precio Unitario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,273,'Importe','importe',120,20,'Lucida Console',8,0,0,1,1,1,49,1,0,0,'Importe');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,681,'Subtotal','subtotal',120,20,'Lucida Console',8,0,0,0,1,1,49,1,0,1,'Subtotal');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,700,'Iva','iva',120,20,'Lucida Console',8,0,0,0,1,1,49,1,0,1,'Iva');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(729,732,'Total','total',120,20,'Lucida Console',8,0,0,0,1,1,49,1,0,1,'Total');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(19,696,'Total letra','totalletra',600,50,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Total letra');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(24,108,'Clave cliente','clavecliente',120,20,'Arial',8,0,0,0,0,0,49,1,0,0,'Clave Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(34,73,'Municipio cliente','municipiocliente',136,20,'Arial',8,0,0,0,0,0,49,1,0,0,'Municipio Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(101,22,'Municipio empresa','municipio',136,20,'Arial',8,0,0,0,0,0,49,1,0,0,'Municipio Empresa');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(562,273,'Tipo','tipocantidad',32,20,'Lucida Console',8,0,0,1,0,1,49,1,0,0,'Tipo Cantidad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(10,10,'CURP','curpcliente',120,20,'Lucida Console',8,0,0,0,0,0,49,1,0,0,'CURP Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,51,'Contacto:','contactocliente',160,20,'Lucida Console',8,0,0,0,0,0,49,1,0,0,'Contacto Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(567,51,'Referencia:','refcliente',160,20,'Lucida Console',8,0,0,0,0,0,49,1,0,0,'Ref. Dom. Cliente');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'% Descuento','descuentopor',120,25,'Lucida Console',8,1,0,1,1,0,49,1,0,0,'% Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Cant. Descuento','descuentocant',120,25,'Lucida Console',8,1,0,1,1,0,49,1,0,0,'Cant. Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Precio s/desc','preciosindesc',120,25,'Lucida Console',8,1,0,1,1,1,49,1,0,0,'Precio s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Importe+Iva','importeiva',120,25,'Lucida Console',8,1,0,1,0,0,49,1,0,0,'Importe + IVA');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(601,321,'Preciou+Iva','preciouiva',120,25,'Lucida Console',8,1,0,1,0,0,49,1,0,0,'PrecioU + IVA');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(12,136,'Vendedor:','vendedor',160,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Vendedor');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(179,132,'Prioridad Mensaje:','prioridadstr',300,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Prioridad Mensaje');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(324,492,'Mensaje Candelado','cancelado',170,20,'Arial',18,0,0,1,0,1,49,1,0,0,'Mensaje Candelado');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,642,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,1,49,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,1,49,1,0,1,'Total Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(179,132,'Prioridad:','prioridad',300,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Prioridad');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,673,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(663,141,'Fecha salida:','fechasalida',100,20,'Lucida Console',10,0,0,0,0,1,49,1,0,0,'Fecha Salida');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(764,141,'Hora salida:','horasalida',100,20,'Lucida Console',10,0,0,0,0,1,49,1,0,0,'Hora Salida');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(14,642,'Surtido:','surtido',700,20,'Lucida Console',8,0,0,0,0,1,49,1,0,0,'Surtido');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','totalcantidad',200,20,'Lucida Console',8,0,0,0,0,0,49,1,0,1,'Total Cantidad');

insert into tblimpresiones(y,yl,documento,idsucursal,rg,alt,modo,ancho) values(270,350,33,1,20,3,0,864);
insert into tblimpresiones(y,yl,documento,idsucursal,rg,alt,modo,ancho) values(270,350,49,1,20,3,0,864);


insert into tblactualizaciones values('ver 9012 rev 10');

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','anticipo',200,20,'Lucida Console',8,0,0,0,0,0,49,1,0,1,'Anticipo');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','restante',200,20,'Lucida Console',8,0,0,0,0,0,49,1,0,1,'Restante');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','anticipo',200,20,'Lucida Console',8,0,0,0,0,0,33,1,0,1,'Anticipo');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(339,59,'Total Cantidad: ','restante',200,20,'Lucida Console',8,0,0,0,0,0,33,1,0,1,'Restante');
insert into tblactualizaciones values('ver 9013 rev 5');


ALTER TABLE `tblinventario` ADD COLUMN `eskit` TINYINT UNSIGNED NOT NULL AFTER `minimo`;

DROP TABLE IF EXISTS `tblinventariodetalles`;
CREATE TABLE  `tblinventariodetalles` (
  `iddetalle` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idinventario` int(10) unsigned NOT NULL,
  `cantidad` double NOT NULL,
  `idinventariop` int(10) unsigned NOT NULL,
  PRIMARY KEY (`iddetalle`),
  KEY `FK_tblinventariodetalles_1` (`idinventariop`),
  CONSTRAINT `FK_tblinventariodetalles_1` FOREIGN KEY (`idinventariop`) REFERENCES `tblinventario` (`idinventario`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `tblventaskits`;
CREATE TABLE `tblventaskits` (
  `iddetallekit` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idventa` int(10) unsigned NOT NULL,
  `idinventario` int(10) unsigned NOT NULL,
  `cantidad` double NOT NULL,
  `surtido` double NOT NULL,
  `iddetalle` int(10) unsigned NOT NULL,
  `idalmacen` int(10) unsigned NOT NULL,
  PRIMARY KEY (`iddetallekit`),
  KEY `FK_tblventaskits_1` (`idventa`),
  CONSTRAINT `FK_tblventaskits_1` FOREIGN KEY (`idventa`) REFERENCES `tblventas` (`idventa`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE `tblventaskitsr` (
  `iddetallekit` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `idremision` INTEGER UNSIGNED NOT NULL,
  `idinventario` INTEGER UNSIGNED NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `surtido` DOUBLE NOT NULL,
  `iddetalle` INTEGER UNSIGNED NOT NULL,
  `idalmacen` INTEGER UNSIGNED NOT NULL,
  PRIMARY KEY (`iddetallekit`)
)
ENGINE = InnoDB;

CREATE TABLE `tblventaskitsc` (
  `iddetallekit` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `idcotizacion` INTEGER UNSIGNED NOT NULL,
  `idinventario` INTEGER UNSIGNED NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `surtido` DOUBLE NOT NULL,
  `iddetalle` INTEGER UNSIGNED NOT NULL,
  `idalmacen` INTEGER UNSIGNED NOT NULL,
  PRIMARY KEY (`iddetallekit`)
)
ENGINE = InnoDB;


CREATE TABLE `tblventaskitsp` (
  `iddetallekit` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `idpedido` INTEGER UNSIGNED NOT NULL,
  `idinventario` INTEGER UNSIGNED NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `surtido` DOUBLE NOT NULL,
  `iddetalle` INTEGER UNSIGNED NOT NULL,
  `idalmacen` INTEGER UNSIGNED NOT NULL,
  PRIMARY KEY (`iddetallekit`)
)
ENGINE = InnoDB;


DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;







if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;

return 1;
END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9013 rev 9');

CREATE TABLE `tblclientesimpuestos` (
  `idimpuesto` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `idcliente` INTEGER UNSIGNED NOT NULL,
  `tipo` TINYINT UNSIGNED NOT NULL,
  `tasa` DOUBLE NOT NULL,
  `nombre` VARCHAR(250) NOT NULL,
  PRIMARY KEY (`idimpuesto`)
)
ENGINE = InnoDB;


insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(120,140,'Imp Locales: ','implocales',400,15,'Lucida Console',8,0,0,0,0,0,0,1,0,0,'Imp. Locales');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(120,140,'Imp Locales: ','implocales',400,15,'Lucida Console',8,0,0,0,0,0,16,1,0,0,'Imp. Locales');

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(312,409,'Importe s/desc','importesindesc',120,25,'Lucida Console',8,1,0,1,1,0,0,1,0,0,'Importe s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(312,409,'Importe s/desc','importesindesc',120,25,'Lucida Console',8,1,0,1,1,0,16,1,0,0,'Importe s/desc');

DELIMITER $$

DROP FUNCTION IF EXISTS `spdadetalleskit` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdadetalleskit`(pidocumento int,piddetalle int,pconseries tinyint,ptipo int) RETURNS varchar(2000) CHARSET utf8
BEGIN
declare varminid int;
declare varmaxid int;
declare varidinventario int;
declare varidventa int;
declare vardetalles varchar(2000);
if ptipo=0 then
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);
set vardetalles='';

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert(tblventaskits.cantidad using utf8),(select tblinventario.clave from tblinventario inner join tblventaskits on tblventaskits.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskits on tblventaskits.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
if pconseries=1 then
set varidinventario=(select idinventario from tblventaskits where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskits where iddetallekit=varminid);
set vardetalles=(select spdaseriesventa(varidinventario,varidventa));
end if;
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

return varseries;
END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9014 rev 2');


DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
end if;
end if;


/********************************************************************/
/********************************************************************/
/****************************************************************/

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


return vcantidad;



END $$

DELIMITER ;



DELIMITER $$

DROP FUNCTION IF EXISTS `spdadetalleskit` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdadetalleskit`(pidocumento int,piddetalle int,pconseries tinyint,ptipo int) RETURNS varchar(2000) CHARSET utf8
BEGIN
declare varminid int;
declare varmaxid int;
declare varidinventario int;
declare varidventa int;
declare vardetalles varchar(2000);
set vardetalles='';
if ptipo=0 then
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskits where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskits on tblventaskits.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskits on tblventaskits.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
if pconseries=1 then
set varidinventario=(select idinventario from tblventaskits where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskits where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;


if ptipo=1 then /*remision*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsr where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsr where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsr where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskitsr on tblventaskitsr.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsr on tblventaskitsr.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsr where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

if ptipo=2 then /*pedido*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsp where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsp where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsp where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskitsp on tblventaskitsp.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsp on tblventaskitsp.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsp where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

if ptipo=3 then /*cotizacion*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsc where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsc where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsc where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskitsc on tblventaskitsc.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsc on tblventaskitsc.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsc where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

return vardetalles;
END $$

DELIMITER ;

ALTER TABLE `tblimpresionesnodos` ADD COLUMN `renglon` TINYINT UNSIGNED NOT NULL AFTER `nombre`;
update tblimpresionesnodos set renglon=0;

CREATE TABLE `tblventasimpuestos` (
  `idimpuesto` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(450) NOT NULL,
  `idventa` INTEGER UNSIGNED NOT NULL,
  `tipo` TINYINT UNSIGNED NOT NULL,
  `tasa` DOUBLE NOT NULL,
  PRIMARY KEY (`idimpuesto`)
)
ENGINE = InnoDB;

ALTER TABLE `tblclientes` ADD COLUMN `activarimpuestos` TINYINT UNSIGNED NOT NULL AFTER `saldoafavor`;

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(159,888,'Total sin ret.','totalsil',120,16,'Lucida Console',8,0,0,0,1,0,0,1,0,1,'TotalSinIL',0);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(159,888,'Total sin ret.','totalsil',120,16,'Lucida Console',8,0,0,0,1,0,16,1,0,1,'TotalSinIL',0);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(13,703,'Total letra','totalletrasil',500,50,'Lucida Console',8,0,0,0,0,0,0,1,0,0,'Total letra sin Imp',0);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(13,703,'Total letra','totalletrasil',500,50,'Lucida Console',8,0,0,0,0,0,16,1,0,0,'Total letra sin Imp',0);

insert into tblactualizaciones values('ver 9014 rev 6');

CREATE TABLE `tblmodelos` (
  `idmodelo` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(45) NOT NULL,
  `codigo` VARCHAR(45) NOT NULL,
  `comentario` VARCHAR(450) NOT NULL,
  PRIMARY KEY (`idmodelo`)
)
ENGINE = InnoDB;

CREATE TABLE `tbltallas` (
  `idtalla` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(45) NOT NULL,
  `codigo` VARCHAR(45) NOT NULL,
  `comentario` VARCHAR(450) NOT NULL,
  PRIMARY KEY (`idtalla`)
)
ENGINE = InnoDB;

CREATE TABLE `tblcolores` (
  `idcolor` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(45) NOT NULL,
  `codigo` VARCHAR(45) NOT NULL,
  `comentario` VARCHAR(450) NOT NULL,
  PRIMARY KEY (`idcolor`)
)
ENGINE = InnoDB;


DROP TABLE IF EXISTS `tblbancos`;
CREATE TABLE  `tblbancos` (
  `codigo` varchar(15) NOT NULL,
  `Nombre` varchar(150) NOT NULL,
  `idBanco` int(10) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`idBanco`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `tblcuentas`;
CREATE TABLE  `tblcuentas` (
  `idCuenta` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Numero` varchar(20) NOT NULL,
  `Banco` varchar(45) NOT NULL,
  `Tipo` varchar(20) NOT NULL,
  PRIMARY KEY (`idCuenta`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `tblccontables`;
CREATE TABLE  `tblccontables` (
  `idCContable` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Cuenta` varchar(5) DEFAULT NULL,
  `N2` varchar(5) DEFAULT NULL,
  `N3` varchar(5) DEFAULT NULL,
  `N4` varchar(5) DEFAULT NULL,
  `Descripcion` varchar(65) DEFAULT NULL,
  `Nivel` varchar(1) DEFAULT NULL,
  `CuentaComp` varchar(35) DEFAULT NULL,
  `Tipo` varchar(20) DEFAULT NULL,
  `Naturaleza` varchar(12) DEFAULT NULL,
  `N5` varchar(5) DEFAULT NULL,
  PRIMARY KEY (`idCContable`)
) ENGINE=InnoDB AUTO_INCREMENT=69 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `tblpagoprov`;
CREATE TABLE  `tblpagoprov` (
  `idPagoProv` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Tipo` varchar(100) NOT NULL,
  `Folio` varchar(20) NOT NULL,
  `Proveedor` varchar(65) NOT NULL,
  `Fecha` varchar(10) NOT NULL,
  `FechaCobro` varchar(10) NOT NULL,
  `Referencia` varchar(80) NOT NULL,
  `Cantidad` varchar(20) NOT NULL,
  `IVA` varchar(5) NOT NULL,
  `Leyenda` tinyint(1) NOT NULL,
  `EsCheque` tinyint(1) NOT NULL,
  `Estado` varchar(10) NOT NULL,
  `nCuenta` varchar(45) DEFAULT NULL,
  `Banco` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`idPagoProv`)
) ENGINE=InnoDB AUTO_INCREMENT=20 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `tblpolizapagoprov`;
CREATE TABLE  `tblpolizapagoprov` (
  `idPoliza` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idPagoProv` int(10) NOT NULL,
  `NumPoliza` varchar(10) NOT NULL,
  `ID` varchar(2) NOT NULL,
  `Cuenta` varchar(30) NOT NULL,
  `Descripcion` varchar(80) NOT NULL,
  `Cargo` varchar(20) NOT NULL,
  `Abono` varchar(20) NOT NULL,
  `Elabora` varchar(50) NOT NULL,
  `Autoriza` varchar(50) NOT NULL,
  `Registra` varchar(50) NOT NULL,
  `Solicitud` varchar(5) NOT NULL,
  `CantidadGravadaISR` varchar(10) NOT NULL,
  `CantidadGravadaIVA` varchar(10) NOT NULL,
  `CantidadGravadaIEPS` varchar(10) NOT NULL,
  `CantidadRetenidaISR` varchar(10) NOT NULL,
  `CantidadRetenidaIVA` varchar(10) NOT NULL,
  `CantidadRetenidaIEPS` varchar(10) NOT NULL,
  PRIMARY KEY (`idPoliza`)
) ENGINE=InnoDB AUTO_INCREMENT=35 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `tbldepostito`;
CREATE TABLE  `tbldepostito` (
  `idDeposito` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Fecha` varchar(12) NOT NULL,
  `Referencia` varchar(80) NOT NULL,
  `Banco` varchar(20) NOT NULL,
  `Cantidad` varchar(20) NOT NULL,
  `nCuenta` varchar(45) DEFAULT NULL,
  `Banco2` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`idDeposito`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `tblpolizadeposito`;
CREATE TABLE  `tblpolizadeposito` (
  `idPoliza` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idDeposito` int(10) unsigned NOT NULL,
  `NumPoliza` varchar(10) NOT NULL,
  `ID` varchar(2) NOT NULL,
  `Cuenta` varchar(30) NOT NULL,
  `Descripcion` varchar(80) NOT NULL,
  `Cargo` varchar(20) NOT NULL,
  `Abono` varchar(20) NOT NULL,
  `Elabora` varchar(50) NOT NULL,
  `Autoriza` varchar(50) NOT NULL,
  `Registra` varchar(50) NOT NULL,
  PRIMARY KEY (`idPoliza`)
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=latin1;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdadetalleskit` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdadetalleskit`(pidocumento int,piddetalle int,pconseries tinyint,ptipo int) RETURNS varchar(2000) CHARSET utf8
BEGIN
declare varminid int;
declare varmaxid int;
declare varidinventario int;
declare varidventa int;
declare vardetalles varchar(2000);
set vardetalles='';
if ptipo=0 then
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskits where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.nombre from tblinventario inner join tblventaskits on tblventaskits.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
if pconseries=1 then
set varidinventario=(select idinventario from tblventaskits where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskits where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;


if ptipo=1 then /*remision*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsr where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsr where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsr where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsr on tblventaskitsr.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsr where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

if ptipo=2 then /*pedido*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsp where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsp where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsp where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsp on tblventaskitsp.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsp where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

if ptipo=3 then /*cotizacion*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsc where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsc where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsc where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsc on tblventaskitsc.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsc where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

return vardetalles;
END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9015 rev 4');

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;







if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;

return 1;
END $$

DELIMITER ;



