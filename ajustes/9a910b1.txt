DELIMITER $$

DROP FUNCTION IF EXISTS `sp_haymovimiento` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `sp_haymovimiento`(pidinventario int) RETURNS int(11)
BEGIN
declare vhay int;

set vhay=ifnull((select count(idinventario) from tblventasinventario where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblcomprasdetalles where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblventascotizacionesinventario where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblcomprascotizaciondetalles where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblcompraspedidosdetalles where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblcomprasremisionesdetalles where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblmovimientosdetalles where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblventaspedidosinventario where idinventario=pidinventario),0);
if vhay<>0 then
return vhay;
end if;
set vhay=ifnull((select count(idinventario) from tblventasremisionesinventario where idinventario=pidinventario),0);

return vhay;
END $$

DELIMITER ;

ALTER TABLE `tblventasremisiones` ADD COLUMN `comentariof` VARCHAR(500) NOT NULL AFTER `idvendedor`;
update tblventasremisiones set comentariof='';
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,3,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,19,1,0,0,'Comentario');

ALTER TABLE `tblopciones` ADD COLUMN `pvrojo` INTEGER UNSIGNED NOT NULL AFTER `idiomacletras`,
 ADD COLUMN `pvverde` INTEGER UNSIGNED NOT NULL AFTER `pvrojo`,
 ADD COLUMN `pvazul` INTEGER UNSIGNED NOT NULL AFTER `pvverde`;
update tblopciones set pvrojo=192,pvverde=255,pvazul=192;
update tblusuarios set permisos7=127;

ALTER TABLE `tblopciones` ADD COLUMN `buscaxfabricante` TINYINT UNSIGNED NOT NULL AFTER `pvazul`;

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,0,3,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,0,3,1,0,1,'Total Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,0,19,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,0,19,1,0,1,'Total Descuento');

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,0,1,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,0,1,1,0,1,'Total Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,0,17,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,0,17,1,0,1,'Total Descuento');

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,0,2,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,0,2,1,0,1,'Total Descuento');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,751,'Subtotal s/desc:','subtotalsindesc',180,22,'Lucida Console',8,1,0,0,1,0,18,1,0,1,'Subtotal s/desc');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(651,780,'Total Descuento:','totaldesc',180,22,'Lucida Console',8,1,0,0,1,0,18,1,0,1,'Total Descuento');

ALTER TABLE `tblopciones` ADD COLUMN `nparcialidades` TINYINT UNSIGNED NOT NULL AFTER `buscaxfabricante`,
 ADD COLUMN `buscamodob` TINYINT UNSIGNED NOT NULL AFTER `nparcialidades`;
update tblopciones set nparcialidades=0,buscamodob=1;

update tblformasdepago set nombre='No aplica' where idforma=1 or idforma=2;

DROP TABLE IF EXISTS `tblinventariocostohtemp2`;
CREATE TABLE  `tblinventariocostohtemp2` (
  `idinventario` int(10) unsigned NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `costo` double NOT NULL,
  KEY `Index_1` (`fecha`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `tblinventariocostohex`;
CREATE TABLE  `tblinventariocostohex` (
  `idinventario` int(10) unsigned NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `costo` double NOT NULL,
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`),
  KEY `Index_1` (`fecha`)
) ENGINE=InnoDB AUTO_INCREMENT=24825 DEFAULT CHARSET=utf8;

DELIMITER $$

DROP FUNCTION IF EXISTS `sprecalculacostos` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `sprecalculacostos`(pfecha varchar(10),pidInventario int,ptipocosteo tinyint) RETURNS int(11)
BEGIN

declare varfechamax varchar(10);
declare vcosto double;

if pidinventario<=0 then
delete from tblinventariocostoh where fecha>=pfecha;
delete from tblinventariocostohc;
delete from tblinventariocostohm;
delete from tblinventariocostohtemp;
delete from tblinventariocostohex;
delete from tblinventariocostohtemp2;
/******************/

  set varfechamax=ifnull((select max(fecha) from tblinventariocostoh where idinventario=pidinventario and fecha<pfecha),'1900/01/01');
  set vcosto=ifnull((select costo from tblinventariocostoh where idinventario=pidinventario and fecha=varfechamax limit 1),0);
  /*update tblinventarioultimo set fecha=varfechamax;*/
  insert into tblinventariocostohex(idinventario,fecha,costo) values(pidinventario,varfechamax,vcosto);

/*******/

insert into tblinventariocostohc(idinventario,fecha,costo) select idinventario,fecha,0 from
tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.fecha>=pfecha and tblcompras.estado=3 group by fecha,idinventario;

insert into tblinventariocostohm(idinventario,fecha,costo) select tblmovimientosdetalles.idinventario,tblmovimientos.fecha,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblinventarioconceptos.idconcepto=tblmovimientos.idconcepto  where tblmovimientos.fecha>=pfecha and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and  tblmovimientos.estado=3 group by fecha,idinventario;

insert into tblinventariocostohtemp(idinventario,fecha,costo) select idinventario,fecha,costo from tblinventariocostohc;
insert into tblinventariocostohtemp(idinventario,fecha,costo) select idinventario,fecha,costo from tblinventariocostohm;
insert into tblinventariocostohtemp2(idinventario,fecha,costo) select idinventario,fecha,0 from tblinventariocostohtemp group by idinventario,fecha,costo order by idinventario,fecha;
insert into tblinventariocostoh(idinventario,fecha,costo) select idinventario,fecha,spsacacostoarticuloafechaa(idinventario,fecha,ptipocosteo) from tblinventariocostohtemp2 order by fecha;

else


delete from tblinventariocostoh where fecha>=pfecha and idinventario=pidinventario;
delete from tblinventariocostohc;
delete from tblinventariocostohm;
delete from tblinventariocostohtemp;
delete from tblinventariocostohtemp2;
delete from tblinventariocostohex;
/******************/

  set varfechamax=ifnull((select max(fecha) from tblinventariocostoh where idinventario=pidinventario and fecha<pfecha),'1900/01/01');
  set vcosto=ifnull((select costo from tblinventariocostoh where idinventario=pidinventario and fecha=varfechamax limit 1),0);
  /*update tblinventarioultimo set fecha=varfechamax;*/
  insert into tblinventariocostohex(idinventario,fecha,costo) values(pidinventario,varfechamax,vcosto);

/*******/

insert into tblinventariocostohm(idinventario,fecha,costo) select tblmovimientosdetalles.idinventario,tblmovimientos.fecha,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblinventarioconceptos.idconcepto=tblmovimientos.idconcepto  where tblmovimientos.fecha>=pfecha and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.estado=3 group by fecha,idinventario;

insert into tblinventariocostohc(idinventario,fecha,costo) select idinventario,fecha,0 from
tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.fecha>=pfecha and tblcomprasdetalles.idinventario=pidinventario and tblcompras.estado=3 group by fecha,idinventario;



insert into tblinventariocostohtemp(idinventario,fecha,costo) select idinventario,fecha,costo from tblinventariocostohc order by fecha;
insert into tblinventariocostohtemp(idinventario,fecha,costo) select idinventario,fecha,costo from tblinventariocostohm order by fecha;
insert into tblinventariocostohtemp2(idinventario,fecha,costo) select idinventario,fecha,0 from tblinventariocostohtemp group by idinventario,fecha,costo order by fecha;
insert into tblinventariocostoh(idinventario,fecha,costo) select idinventario,fecha,spsacacostoarticuloafechaa(idinventario,fecha,ptipocosteo) from tblinventariocostohtemp2 order by fecha;

end if;

return 1;
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spsacacostoarticuloafechaa` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spsacacostoarticuloafechaa`(pidinventario int,pfecha1 varchar(10),ptipocosteo tinyint) RETURNS double
BEGIN

declare c int;
declare minimo int;
declare maximo int;
declare vcantidad double;
declare vprecio double;
declare vcosto double;
declare vcosto2 double;
declare vcosto3 double;
declare vinvfinal double;
declare varfechamax varchar(10);
declare varinvant double;
declare varidmax int;
if ptipocosteo=0 then

  delete from tblinventariosacacostos where idinventario=pidinventario;
  delete from tblinventariosacacostosm where idinventario=pidinventario;
  delete from tblinventariosacacostosr where idinventario=pidinventario;
  delete from tblinventariosacacostosf where idinventario=pidinventario;
  delete from tblinventariosacacostosf2 where idinventario=pidinventario;

  insert into tblinventariosacacostos(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasdetalles.cantidad),sum(tblcomprasdetalles.costoindirecto+(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)))  from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha=pfecha1 and tblcomprasdetalles.idinventario=pidinventario group by fecha,idinventario;
  insert into tblinventariosacacostosr(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasremisionesdetalles.cantidad),sum(if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.precio*tblcomprasremisiones.tipodecambio))  from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where tblcomprasremisiones.estado=3 and  tblcomprasremisiones.fecha=pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.usado=0 group by fecha,idinventario;
  insert into tblinventariosacacostosm(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblmovimientosdetalles.cantidad),sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio))  from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha=pfecha1 and idinventario=pidinventario group by fecha,idinventario;


  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostos.idinventario,tblinventariosacacostos.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos left outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostos.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos right outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosr.idinventario,tblinventariosacacostosr.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr left outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosr.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr right outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf2(idinventario,fecha,cantidad,precio,invfinal) select idinventario,fecha,cantidad,precio,spdainventarioafecha(idinventario,f2.fecha,0,0)
   from tblinventariosacacostosf as f2 where f2.idinventario=pidinventario group by f2.fecha order by f2.fecha;

  set minimo=ifnull((select min(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set maximo=ifnull((select max(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set c=minimo;
  /*set vcosto=0;*/
  /*set varidmax=ifnull((select max(fecha) from tblinventariocostohex where idinventario=pidinventario and fecha<pfecha1),0);*/
  set varfechamax=ifnull((select max(fecha) from tblinventariocostohex where fecha<pfecha1),'1900/01/01');
  /*set varfechamax=(select fecha from tblinventarioultimo);*/
  set vcosto=ifnull((select costo from tblinventariocostohex where fecha=varfechamax limit 1),0);
  /*insert into tbldebug values(pidinventario,pfecha1,vcosto,varfechamax,0,0,0,0,0,0,c);*/
  while c<=maximo do

    set vcantidad=(select cantidad from tblinventariosacacostosf2 where id=c);
    set vprecio=(select precio from tblinventariosacacostosf2 where id=c);
    set vinvfinal=(select invfinal from tblinventariosacacostosf2 where id=c);
    if vcantidad+vinvfinal>0 then
      set vcosto=(vprecio+(vinvfinal*vcosto))/(vcantidad+vinvfinal);
    else
      set vcosto=0;
    end if;

    set c=c+1;
     /*insert into tbldebug values(pidinventario,pfecha1,vcosto,varfechamax,vcantidad,vprecio,vinvfinal,1,vprecio+(vinvfinal*vcosto),vcantidad+vinvfinal,c);*/
  end while;
/*    update tblinventarioultimo set fecha=pfecha1;*/
    insert into tblinventariocostohex(idinventario,fecha,costo) values(pidinventario,pfecha1,vcosto);
else

set vcosto=ifnull((select if(tblcomprasdetalles.idmoneda=2,max(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad+tblcomprasdetalles.costoindirecto),max(tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad)*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha<=pfecha1 and tblcomprasdetalles.idinventario=pidinventario and tblcomprasdetalles.cantidad<>0),0);
set vcosto3=ifnull((select if(tblcomprasremisionesdetalles.idmoneda=2,max(tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad),max((tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad)*tblcomprasremisiones.tipodecambio)) from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where (tblcomprasremisiones.estado=3) and  tblcomprasremisiones.fecha<=pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisionesdetalles.cantidad<>0 and tblcomprasremisiones.usado=0),0);
set vcosto2=ifnull((select if(tblmovimientosdetalles.idmoneda=2,max(tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad),max((tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad)*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha<=pfecha1 and idinventario=pidinventario and tblmovimientosdetalles.cantidad<>0),0);
if vcosto2>vcosto then
set vcosto=vcosto2;
end if;
if vcosto3>vcosto then
set vcosto=vcosto3;
end if;

end if;

return ifnull(vcosto,0);



END $$

DELIMITER ;

ALTER TABLE `tblcompras` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `folioi`;
update tblcompras set comentario='';
ALTER TABLE `tblcomprasremisiones` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `horacancelado`;
update tblcomprasremisiones set comentario='';
ALTER TABLE `tblcompraspedidos` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `serie`;
update tblcompraspedidos set comentario='';
ALTER TABLE `tblcomprascotizacionesb` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `serie`;
update tblcomprascotizacionesb set comentario='';
ALTER TABLE `tbldevoluciones` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `idremision`;
update tbldevoluciones set comentario='';
ALTER TABLE `tbldevolucionescompras` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `idremision`;
update tbldevolucionescompras set comentario='';
ALTER TABLE `tblnotasdecredito` ADD COLUMN `comentarionc` VARCHAR(1000) NOT NULL AFTER `idconcepto`;
update tblnotasdecredito set comentarionc='';
ALTER TABLE `tblnotasdecargo` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `idconcepto`;
update tblnotasdecargo set comentario='';
ALTER TABLE `tblnotasdecargocompras` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `idconcepto`;
update tblnotasdecargocompras set comentario='';
ALTER TABLE `tblnotasdecreditocompras` ADD COLUMN `comentarionc` VARCHAR(1000) NOT NULL AFTER `idconcepto`;
update tblnotasdecreditocompras set comentarionc='';
ALTER TABLE `tblventascotizaciones` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `idvendedor`;
update tblventascotizaciones set comentario='';
ALTER TABLE `tblventaspedidos` ADD COLUMN `comentario` VARCHAR(1000) NOT NULL AFTER `idvendedor`;
update tblventaspedidos set comentario='';
delete from tblimpresionesnodos where datapropertyname='cancelado' and (documento=15 or documento=31);

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,1,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,17,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,2,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,18,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,4,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,20,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,5,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,21,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,6,1,0,0,'Comentario');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Comentario','comentario',700,20,'Lucida Console',8,0,0,0,0,0,22,1,0,0,'Comentario');



CREATE TABLE  `tblreppagos` (
  `idpago` int(10) unsigned NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `cantidad` double NOT NULL,
  `tipo` varchar(2000) NOT NULL,
  `serie` varchar(45) NOT NULL,
  `folio` int(10) unsigned NOT NULL,
  `nombre` varchar(345) NOT NULL,
  `credito` double NOT NULL,
  `totalapagar` double NOT NULL,
  `idventa` int(10) unsigned NOT NULL,
  `fechaf` varchar(10) NOT NULL,
  `tipocd` varchar(45) NOT NULL,
  `idconceptonotaventa` int(10) unsigned NOT NULL,
  `nombre1` varchar(245) NOT NULL,
  `idsucursal` int(10) unsigned NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
insert into tblconceptosnotasventas values(90,'Venta Contado',2);
insert into tblconceptosnotascompras values(90,'Compra Contado',2);

CREATE TABLE `tblreppagosc` (
  `idpago` int(10) unsigned NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `cantidad` double NOT NULL,
  `tipo` varchar(2000) NOT NULL,
  `serie` varchar(45) NOT NULL,
  `folio` int(10) unsigned NOT NULL,
  `nombre` varchar(345) NOT NULL,
  `credito` double NOT NULL,
  `totalapagar` double NOT NULL,
  `idcompra` int(10) unsigned NOT NULL,
  `fechaf` varchar(10) NOT NULL,
  `tipocd` varchar(45) NOT NULL,
  `idconceptonotacompra` int(10) unsigned NOT NULL,
  `nombre1` varchar(245) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `tblrepmovimientosxarticulo` (
  `idventa` int(10) unsigned NOT NULL,
  `tipodoc` varchar(2) NOT NULL,
  `folio` varchar(45) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `nombre` varchar(450) NOT NULL,
  `cantidad` double NOT NULL,
  `preciou` double NOT NULL,
  `precio` double NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

ALTER TABLE `tblventas` ADD COLUMN `porsurtir` TINYINT UNSIGNED NOT NULL AFTER `parcialidades`;

ALTER TABLE `tblventasremisiones` ADD COLUMN `porsurtir` TINYINT UNSIGNED NOT NULL AFTER `comentariof`,
 ADD COLUMN `idventar` INTEGER UNSIGNED NOT NULL AFTER `porsurtir`;

ALTER TABLE `tblmovimientos` ADD COLUMN `idventa` INTEGER UNSIGNED NOT NULL AFTER `idmoneda`,
 ADD COLUMN `idremision` INTEGER UNSIGNED NOT NULL AFTER `idventa`;


insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Facturado en: ','folioref',300,20,'Lucida Console',8,0,0,0,0,0,3,1,0,0,'Facturado en');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Facturado en: ','folioref',300,20,'Lucida Console',8,0,0,0,0,0,19,1,0,0,'Facturado en');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Referencia: ','folioref',300,20,'Lucida Console',8,0,0,0,0,0,14,1,0,0,'Referencia');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Referencia: ','folioref',300,20,'Lucida Console',8,0,0,0,0,0,14+16,1,0,0,'Referencia');

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;








if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.estado=3),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=3),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=3),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.estado=3),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=3),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=3),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.estado=3 and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=3 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=3 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and tblventas.estado=3 and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and tblventas.estado=3 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and tblventas.estado=3 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and tbldevoluciones.estado=3),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and tbldevoluciones.estado=3 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and tbldevoluciones.estado=3 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and tblventasremisiones.estado=3 and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and tblventasremisiones.estado=3 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and tblventasremisiones.estado=3 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and tblmovimientos.estado=3 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


return vcantidad;



END $$

DELIMITER ;

DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then


insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario>1;


    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario>1;

    else
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario>1;

    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario>1;


      else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

if pidsucursal<=0 then
if pidalmacen <=0 then
if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
end if;
end if;


return 0;


END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spclientesmovimientos` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spclientesmovimientos`(pidcliente int,pfecha1 varchar(10),pfecha2 varchar(10)) RETURNS int(11)
BEGIN

delete from tblclientesmovimientos where idcliente=pidcliente;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,8,idremision,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepagoremisiones.tipo=3 and usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,8,idremision,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,hora,3,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and (tblformasdepagoremisiones.tipo=1 or tblformasdepagoremisiones.tipo=2) and usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,2,idnota,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,hora,3,serie,folio from tblnotasdecredito where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,3,iddevolucion,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,hora,3,serie,folio from tbldevoluciones where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidcliente,tblventaspagos.hora,3,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidcliente,tblventaspagos.hora,3,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidcliente,tblventaspagos.hora,3,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagosremisiones.fecha,4,idpago,0,if(tblventaspagosremisiones.idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidcliente,tblventaspagosremisiones.hora,3,tblventasremisiones.serie as serie,
tblventasremisiones.folio as folio from tblventaspagosremisiones inner join tblventasremisiones on tblventasremisiones.idremision=tblventaspagosremisiones.idremision where tblventaspagosremisiones.idcliente=pidcliente and (tblventaspagosremisiones.estado=3 or tblventaspagosremisiones.estado=4) and tblventaspagosremisiones.fecha>=pfecha1 and tblventaspagosremisiones.fecha<=pfecha2  and tblventaspagosremisiones.idremision<>0 and tblventasremisiones.usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,5,idcargo,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,serie,folio from tblnotasdecargo where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,6,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,seriereferencia,folioreferencia from tbldocumentosclientes where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,7,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,serie,folio from tbldocumentosclientes where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=0;



insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,8,idremision,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepagoremisiones.tipo=3 and usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,8,idremision,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and (tblformasdepagoremisiones.tipo=1 or tblformasdepagoremisiones.tipo=2) and usado=0;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,2,idnota,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,horacancelado,4,serie,folio from tblnotasdecredito where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,3,iddevolucion,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,horacancelado,4,serie,folio from tbldevoluciones where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;



insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.horacancelado,4,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.horacancelado,4,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.horacancelado,4,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagosremisiones.fechacancelado,4,idpago,if(tblventaspagosremisiones.idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagosremisiones.horacancelado,4,tblventasremisiones.serie as serie,
tblventasremisiones.folio as folio from tblventaspagosremisiones inner join tblventasremisiones on tblventasremisiones.idremision=tblventaspagosremisiones.idremision where tblventaspagosremisiones.idcliente=pidcliente and tblventaspagosremisiones.estado=4 and tblventaspagosremisiones.fechacancelado>=pfecha1 and tblventaspagosremisiones.fechacancelado<=pfecha2 and tblventaspagosremisiones.idremision<>0 and tblventasremisiones.usado=0;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,5,idcargo,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblnotasdecargo where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,6,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,seriereferencia,folioreferencia from tbldocumentosclientes where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,7,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tbldocumentosclientes where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=0;








return pidcliente;
END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spclientesmovimientostodos` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spclientesmovimientostodos`(pfecha1 varchar(10),pfecha2 varchar(10)) RETURNS int(11)
BEGIN

delete from tblclientesmovimientos;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,8,idremision,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepagoremisiones.tipo=3 and usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,8,idremision,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,hora,3,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where  (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and (tblformasdepagoremisiones.tipo=1 or tblformasdepagoremisiones.tipo=2) and usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,2,idnota,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,hora,3,serie,folio from tblnotasdecredito where  (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,3,iddevolucion,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,hora,3,serie,folio from tbldevoluciones where  (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,idcliente,tblventaspagos.hora,3,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where  (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,idcliente,tblventaspagos.hora,3,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where  (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,idcliente,tblventaspagos.hora,3,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagosremisiones.fecha,4,idpago,0,if(tblventaspagosremisiones.idmoneda=2,cantidad,cantidad*ptipodecambio),0,tblventaspagosremisiones.idcliente,tblventaspagosremisiones.hora,3,tblventasremisiones.serie as serie,
tblventasremisiones.folio as folio from tblventaspagosremisiones inner join tblventasremisiones on tblventasremisiones.idremision=tblventaspagosremisiones.idremision where (tblventaspagosremisiones.estado=3 or tblventaspagosremisiones.estado=4) and tblventaspagosremisiones.fecha>=pfecha1 and tblventaspagosremisiones.fecha<=pfecha2  and tblventaspagosremisiones.idremision<>0 and tblventasremisiones.usado=0;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,5,idcargo,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,serie,folio from tblnotasdecargo where  (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,6,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,seriereferencia,folioreferencia from tbldocumentosclientes where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,7,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,serie,folio from tbldocumentosclientes where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=0;



insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,8,idremision,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepagoremisiones.tipo=3 and usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,8,idremision,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblventasremisiones inner join tblformasdepagoremisiones on tblventasremisiones.idforma=tblformasdepagoremisiones.idforma where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and (tblformasdepagoremisiones.tipo=1 or tblformasdepagoremisiones.tipo=2) and usado=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,2,idnota,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,horacancelado,4,serie,folio from tblnotasdecredito where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,3,iddevolucion,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,horacancelado,4,serie,folio from tbldevoluciones where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;



insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,idcliente,tblventaspagos.horacancelado,4,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where  tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,idcliente,tblventaspagos.horacancelado,4,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,idcliente,tblventaspagos.horacancelado,4,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagosremisiones.fechacancelado,4,idpago,if(tblventaspagosremisiones.idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,tblventaspagosremisiones.idcliente,tblventaspagosremisiones.horacancelado,4,tblventasremisiones.serie as serie,
tblventasremisiones.folio as folio from tblventaspagosremisiones inner join tblventasremisiones on tblventasremisiones.idremision=tblventaspagosremisiones.idremision where tblventaspagosremisiones.estado=4 and tblventaspagosremisiones.fechacancelado>=pfecha1 and tblventaspagosremisiones.fechacancelado<=pfecha2 and tblventaspagosremisiones.idremision<>0 and tblventasremisiones.usado=0;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,5,idcargo,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblnotasdecargo where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,6,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,seriereferencia,folioreferencia from tbldocumentosclientes where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,7,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tbldocumentosclientes where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=0;



return 0;
END $$

DELIMITER ;


DROP TABLE IF EXISTS `tblrepmovimientosxarticulo`;
CREATE TABLE `tblrepmovimientosxarticulo` (
  `idventa` int(10) unsigned NOT NULL,
  `tipodoc` varchar(2) NOT NULL,
  `folio` varchar(45) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `nombre` varchar(450) NOT NULL,
  `cantidad` double NOT NULL,
  `preciou` double NOT NULL,
  `precio` double NOT NULL,
  `fecha` varchar(10) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `tblrepventasporsurtir` (
  `folio` INTEGER UNSIGNED NOT NULL,
  `serie` VARCHAR(45) NOT NULL,
  `fecha` VARCHAR(10) NOT NULL,
  `idcliente` INTEGER UNSIGNED NOT NULL,
  `nombre` VARCHAR(200) NOT NULL,
  `clave` VARCHAR(45) NOT NULL,
  `inombre` VARCHAR(200) NOT NULL,
  `cantidad` DOUBLE NOT NULL,
  `csurtido` DOUBLE NOT NULL,
  `tipo` VARCHAR(5) NOT NULL
)
ENGINE = InnoDB;

CREATE TABLE  `tblrepventasporsurtird` (
  `folio` int(10) unsigned NOT NULL,
  `serie` varchar(45) NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `idcliente` int(10) unsigned NOT NULL,
  `nombre` varchar(200) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `inombre` varchar(200) NOT NULL,
  `cantidad` double NOT NULL,
  `csurtido` double NOT NULL,
  `tipo` varchar(5) NOT NULL,
  `cantidadm` double NOT NULL,
  `fecham` varchar(10) NOT NULL,
  `seriem` varchar(45) NOT NULL,
  `foliom` int(10) unsigned NOT NULL,
  `idventa` int(10) unsigned NOT NULL,
  `idmovimiento` int(10) unsigned NOT NULL

) ENGINE=InnoDB DEFAULT CHARSET=utf8;


ALTER TABLE `tblclientes` ADD COLUMN `saldoafavor` DOUBLE NOT NULL AFTER `usaadenda`;
ALTER TABLE `tblinventario` ADD COLUMN `esamortizacion` TINYINT UNSIGNED NOT NULL AFTER `usaformula`,
 ADD COLUMN `peso` DOUBLE NOT NULL AFTER `esamortizacion`,
 ADD COLUMN `maximo` DOUBLE NOT NULL AFTER `peso`,
 ADD COLUMN `minimo` DOUBLE NOT NULL AFTER `maximo`;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavor` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavor`(pidcliente int) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente),0)+ifnull((select sum(precio*(1+iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente),0);
END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavor` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavor`(pidcliente int) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente),0);
END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

/* Descontar canceladas  ********************************/
/***********************************************************/


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;

ALTER TABLE `tblcomprasremisiones` ADD COLUMN `idcomprar` INTEGER UNSIGNED NOT NULL AFTER `comentario`;

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;








if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,0,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,16,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,3,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,19,1,0,0,'Peso');


DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

/*if pidsucursal<=0 then
if pidalmacen <=0 then*/
if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
/*end if;
end if;*/


return 0;


END $$

DELIMITER ;


DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then


insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 and tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else

insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;


insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,1,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,17,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,2,1,0,0,'Peso');
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre) values(13,643,'Peso: ','peso',300,20,'Lucida Console',8,0,0,0,0,0,18,1,0,0,'Peso');


CREATE TABLE  `tblrepsaldoafavor` (
  `idcliente` int(10) unsigned NOT NULL,
  `fecha` varchar(10) NOT NULL,
  `serie` varchar(45) NOT NULL,
  `folio` int(10) unsigned NOT NULL,
  `nombrec` varchar(250) NOT NULL,
  `clave` varchar(45) NOT NULL,
  `precio` double NOT NULL,
  `iva` double NOT NULL,
  `tipo` varchar(2) NOT NULL,
  `cantidad` double NOT NULL,
  `saldoant` double NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


ALTER TABLE `tblinventariomovimientosk2` MODIFY COLUMN `serie` VARCHAR(45) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 MODIFY COLUMN `folio` VARCHAR(45) NOT NULL;



DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavorafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavorafecha`(pidcliente int,pfecha varchar(10)) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente and tblventas.fecha<pfecha),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente and tblventasremisiones.fecha<pfecha),0);
END $$

DELIMITER ;

ALTER TABLE `tblinventariomovimientosk` ADD COLUMN `folioref` VARCHAR(45) NOT NULL AFTER `idalmacen2`,
 ADD COLUMN `tiporef` VARCHAR(20) NOT NULL AFTER `folioref`;

CREATE TABLE `tblactualizaciones` (
  `version` VARCHAR(45) NOT NULL
)
ENGINE = InnoDB;



DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

/* Descontar canceladas  ********************************/
/***********************************************************/


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0  and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;








if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9009 beta 1');


delete from tblventasremisiones where usado=1 and idventar=0;

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,
ifnull((select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa limit 1),''),''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;





/********************************************************************************/
/**********************************************************************************/
/*******************************************************************************/



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

/* Descontar canceladas  ********************************/
/***********************************************************/


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;





return vcantidad;



END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9009 beta 4');

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;





/********************************************************************************/
/**********************************************************************************/
/*******************************************************************************/



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;

update tblalmacenesi inner join tblalmacenes on tblalmacenesi.idalmacen=tblalmacenes.idalmacen set cantidad=spdainventarioafecha(idinventario,'2014/01/01',idsucursal,tblalmacenesi.idalmacen);
insert into tblactualizaciones values('ver 9009 beta 4b');


CREATE TABLE  `tbladdendaley` (
  `idaddenda` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idventa` int(10) unsigned NOT NULL,
  `clasificacion` tinyint(3) unsigned NOT NULL,
  `tipo` tinyint(3) unsigned NOT NULL,
  `proveedor` varchar(15) NOT NULL,
  `centro` varchar(15) NOT NULL,
  `numeroentrada` varchar(15) NOT NULL,
  `noremision` varchar(15) NOT NULL,
  `proveedorsap` varchar(15) NOT NULL,
  `nombreproveedor` varchar(300) NOT NULL,
  `fechaentrada` varchar(10) NOT NULL,
  `descuento` double NOT NULL,
  `pedido` varchar(15) NOT NULL,
  PRIMARY KEY (`idaddenda`),
  KEY `FK_tbladdendaley_1` (`idventa`),
  CONSTRAINT `FK_tbladdendaley_1` FOREIGN KEY (`idventa`) REFERENCES `tblventas` (`idventa`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavor` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavor`(pidcliente int) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente and tblventasremisiones.usado=0),0);
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdasaldoafavorafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdasaldoafavorafecha`(pidcliente int,pfecha varchar(10)) RETURNS double
BEGIN
return ifnull((select sum(precio*(1+tblventasinventario.iva/100)) from tblventasinventario inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario inner join tblventas on tblventas.idventa=tblventasinventario.idventa where tblinventario.esamortizacion=1 and tblventas.estado=3 and tblventas.idcliente=pidcliente and tblventas.fecha<pfecha),0)+ifnull((select sum(precio*(1+tblventasremisionesinventario.iva/100)) from tblventasremisionesinventario inner join tblinventario on tblventasremisionesinventario.idinventario=tblinventario.idinventario inner join tblventasremisiones on tblventasremisiones.idremision=tblventasremisionesinventario.idremision where tblinventario.esamortizacion=1 and tblventasremisiones.estado=3 and tblventasremisiones.idcliente=pidcliente and tblventasremisiones.fecha<pfecha and tblventasremisiones.usado=0),0);
END $$

DELIMITER ;

DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then

/* Todas sucursales todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


    else
/* Todas sucursales todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then
/* Todas sucursales un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* Todas sucursales un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then
/* una sucursal todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* una sucursal todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then
/* una sucursal un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else
/* Una sucursal un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=3 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spanalisisinventariocc` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spanalisisinventariocc`(pfecha1 varchar(10),pfecha2 varchar(10),pidinventario int,pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventarioanalisisc;

if pidsucursal<=0 then
/*if pidalmacen <=0 then*/
if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario group by tblinventarioconceptos.idconcepto;



end if;
else
/*Para una sola sucursal*/
if pidinventario<=0 then


insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.costoindirecto),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;

else



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)),0),0 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblcompras.idcompra,0,'Gastos s/compra',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(tblcomprasdetalles.costoindirecto),0),1 from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra where tblcompras.estado=3 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Devoluciones Ventas',ifnull(sum(tbldevolucionesdetalles.cantidad),0),ifnull(sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)),0),2 from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion inner join tblinventario on tbldevolucionesdetalles.idinventario=tblinventario.idinventario where tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,0,'Cancelaciones Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),3 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where tblventas.estado=4 and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,0,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)),0),4 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Ventas',ifnull(sum(tblventasinventario.cantidad),0),ifnull(sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)),0),0 from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa inner join tblinventario on tblventasinventario.idinventario=tblinventario.idinventario where (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idinventario=pidinventario and tblventas.porsurtir=0 and tblventas.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Devoluciones Compras',ifnull(sum(tbldevolucionesdetallesc.cantidad),0),ifnull(sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)),0),1 from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select 0,1,'Cancelaciones Compras',ifnull(sum(tblcomprasdetalles.cantidad),0),ifnull(sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio),tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio*tblcompras.tipodecambio))),0),2 from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idinventario=pidinventario and tblcompras.idsucursal=pidsucursal;
insert into tblinventarioanalisisc(idinventario,tipo,concepto,cantidad,precio,orden)
select tblinventarioconceptos.idconcepto,1,tblinventarioconceptos.nombre,ifnull(sum(tblmovimientosdetalles.cantidad),0),ifnull(sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)),0),3 from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblinventario on tblmovimientosdetalles.idinventario=tblinventario.idinventario where tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idinventario=pidinventario and tblmovimientos.idsucursal=pidsucursal group by tblinventarioconceptos.idconcepto;



end if;
/*end if;*/
end if;


return 0;


END $$

DELIMITER ;


DELIMITER $$

DROP FUNCTION IF EXISTS `spsacacostoarticuloafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spsacacostoarticuloafecha`(pidinventario int,pfecha1 varchar(10),ptipocosteo tinyint) RETURNS double
BEGIN
declare c int;
declare minimo int;
declare maximo int;
declare vcantidad double;
declare vprecio double;
declare vcosto double;
declare vcosto2 double;
declare vcosto3 double;
declare vinvfinal double;

if ptipocosteo=0 then
  
  delete from tblinventariosacacostos where idinventario=pidinventario;
  delete from tblinventariosacacostosm where idinventario=pidinventario;
  delete from tblinventariosacacostosr where idinventario=pidinventario;
  delete from tblinventariosacacostosf where idinventario=pidinventario;
  delete from tblinventariosacacostosf2 where idinventario=pidinventario;

  insert into tblinventariosacacostos(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasdetalles.cantidad),sum(tblcomprasdetalles.costoindirecto+(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)))  from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha<pfecha1 and tblcomprasdetalles.idinventario=pidinventario group by fecha,idinventario;
  insert into tblinventariosacacostosr(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasremisionesdetalles.cantidad),sum(if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.precio*tblcomprasremisiones.tipodecambio))  from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where tblcomprasremisiones.estado=3 and  tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.usado=0 group by fecha,idinventario;
  insert into tblinventariosacacostosm(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblmovimientosdetalles.cantidad),sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio))  from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha<pfecha1 and idinventario=pidinventario group by fecha,idinventario;


  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostos.idinventario,tblinventariosacacostos.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos left outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostos.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos right outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
 insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosr.idinventario,tblinventariosacacostosr.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr left outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosr.idinventario=pidinventario;
 insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr right outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf2(idinventario,fecha,cantidad,precio,invfinal) select idinventario,fecha,cantidad,precio,spdainventarioafecha(idinventario,f2.fecha,0,0)
   from tblinventariosacacostosf as f2 where f2.idinventario=pidinventario group by f2.fecha order by f2.fecha;

  set minimo=ifnull((select min(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set maximo=ifnull((select max(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set c=minimo;
  set vcosto=0;

  while c<=maximo do

    set vcantidad=(select cantidad from tblinventariosacacostosf2 where id=c);
    set vprecio=(select precio from tblinventariosacacostosf2 where id=c);
    set vinvfinal=(select invfinal from tblinventariosacacostosf2 where id=c);

    if vcantidad+vinvfinal>0 then
      set vcosto=(vprecio+(vinvfinal*vcosto))/(vcantidad+vinvfinal);
    else
      set vcosto=0;
    end if;

    set c=c+1;
  end while;

else
  
set vcosto=ifnull((select if(tblcomprasdetalles.idmoneda=2,max(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad+tblcomprasdetalles.costoindirecto),max(tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad)*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha<pfecha1 and tblcomprasdetalles.idinventario=pidinventario and tblcomprasdetalles.cantidad<>0),0);
set vcosto3=ifnull((select if(tblcomprasremisionesdetalles.idmoneda=2,max(tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad),max((tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad)*tblcomprasremisiones.tipodecambio)) from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where (tblcomprasremisiones.estado=3) and  tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisionesdetalles.cantidad<>0 and tblcomprasremisiones.usado=0),0);
set vcosto2=ifnull((select if(tblmovimientosdetalles.idmoneda=2,max(tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad),max((tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad)*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha<pfecha1 and idinventario=pidinventario and tblmovimientosdetalles.cantidad<>0),0);
if vcosto2>vcosto then
set vcosto=vcosto2;
end if;
if vcosto3>vcosto then
set vcosto=vcosto3;
end if;

end if;

update tblinventarioprecios inner join tblinventario on tblinventarioprecios.idinventario=tblinventario.idinventario
set tblinventarioprecios.precio=vcosto*(1+tblinventarioprecios.utilidad/100)
where tblinventarioprecios.idinventario=pidinventario and tblinventarioprecios.utilidad<>0;


return ifnull(vcosto,0);
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spsacacostoarticuloafechaa` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spsacacostoarticuloafechaa`(pidinventario int,pfecha1 varchar(10),ptipocosteo tinyint) RETURNS double
BEGIN

declare c int;
declare minimo int;
declare maximo int;
declare vcantidad double;
declare vprecio double;
declare vcosto double;
declare vcosto2 double;
declare vcosto3 double;
declare vinvfinal double;
declare varfechamax varchar(10);
declare varinvant double;
declare varidmax int;
if ptipocosteo=0 then

  delete from tblinventariosacacostos where idinventario=pidinventario;
  delete from tblinventariosacacostosm where idinventario=pidinventario;
  delete from tblinventariosacacostosr where idinventario=pidinventario;
  delete from tblinventariosacacostosf where idinventario=pidinventario;
  delete from tblinventariosacacostosf2 where idinventario=pidinventario;

  insert into tblinventariosacacostos(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasdetalles.cantidad),sum(tblcomprasdetalles.costoindirecto+(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.precio,tblcomprasdetalles.precio*tblcompras.tipodecambio)))  from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha=pfecha1 and tblcomprasdetalles.idinventario=pidinventario group by fecha,idinventario;
  insert into tblinventariosacacostosr(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblcomprasremisionesdetalles.cantidad),sum(if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.precio*tblcomprasremisiones.tipodecambio))  from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where tblcomprasremisiones.estado=3 and  tblcomprasremisiones.fecha=pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.usado=0 group by fecha,idinventario;
  insert into tblinventariosacacostosm(idinventario,fecha,cantidad,precio) select idinventario,fecha,sum(tblmovimientosdetalles.cantidad),sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio))  from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha=pfecha1 and idinventario=pidinventario group by fecha,idinventario;


  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostos.idinventario,tblinventariosacacostos.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos left outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostos.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostos.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostos.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostos right outer join tblinventariosacacostosm on tblinventariosacacostos.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostos.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosr.idinventario,tblinventariosacacostosr.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr left outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosr.idinventario=pidinventario;
  insert into tblinventariosacacostosf(idinventario,fecha,cantidad,precio) select tblinventariosacacostosm.idinventario,tblinventariosacacostosm.fecha,ifnull(tblinventariosacacostosr.cantidad,0)+ifnull(tblinventariosacacostosm.cantidad,0),ifnull(tblinventariosacacostosr.precio,0)+ifnull(tblinventariosacacostosm.precio,0) from tblinventariosacacostosr right outer join tblinventariosacacostosm on tblinventariosacacostosr.idinventario=tblinventariosacacostosm.idinventario and tblinventariosacacostosr.fecha=tblinventariosacacostosm.fecha where tblinventariosacacostosm.idinventario=pidinventario;
  insert into tblinventariosacacostosf2(idinventario,fecha,cantidad,precio,invfinal) select idinventario,fecha,cantidad,precio,spdainventarioafecha(idinventario,f2.fecha,0,0)
   from tblinventariosacacostosf as f2 where f2.idinventario=pidinventario group by f2.fecha order by f2.fecha;

  set minimo=ifnull((select min(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set maximo=ifnull((select max(id) from tblinventariosacacostosf2 where idinventario=pidinventario),0);
  set c=minimo;
  /*set vcosto=0;*/
  /*set varidmax=ifnull((select max(fecha) from tblinventariocostohex where idinventario=pidinventario and fecha<pfecha1),0);*/
  set varfechamax=ifnull((select max(fecha) from tblinventariocostohex where fecha<pfecha1),'1900/01/01');
  /*set varfechamax=(select fecha from tblinventarioultimo);*/
  set vcosto=ifnull((select costo from tblinventariocostohex where fecha=varfechamax limit 1),0);
  /*insert into tbldebug values(pidinventario,pfecha1,vcosto,varfechamax,0,0,0,0,0,0,c);*/
  while c<=maximo do

    set vcantidad=(select cantidad from tblinventariosacacostosf2 where id=c);
    set vprecio=(select precio from tblinventariosacacostosf2 where id=c);
    set vinvfinal=(select invfinal from tblinventariosacacostosf2 where id=c);
    if vcantidad+vinvfinal>0 then
      set vcosto=(vprecio+(vinvfinal*vcosto))/(vcantidad+vinvfinal);
    else
      set vcosto=0;
    end if;

    set c=c+1;
     /*insert into tbldebug values(pidinventario,pfecha1,vcosto,varfechamax,vcantidad,vprecio,vinvfinal,1,vprecio+(vinvfinal*vcosto),vcantidad+vinvfinal,c);*/
  end while;
/*    update tblinventarioultimo set fecha=pfecha1;*/
    insert into tblinventariocostohex(idinventario,fecha,costo) values(pidinventario,pfecha1,vcosto);
else

set vcosto=ifnull((select if(tblcomprasdetalles.idmoneda=2,max(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad+tblcomprasdetalles.costoindirecto),max(tblcomprasdetalles.costoindirecto+(tblcomprasdetalles.precio/tblcomprasdetalles.cantidad)*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where (tblcompras.estado=3) and  tblcompras.fecha<=pfecha1 and tblcomprasdetalles.idinventario=pidinventario and tblcomprasdetalles.cantidad<>0),0);
set vcosto3=ifnull((select if(tblcomprasremisionesdetalles.idmoneda=2,max(tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad),max((tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad)*tblcomprasremisiones.tipodecambio)) from tblcomprasremisionesdetalles inner join tblcomprasremisiones on tblcomprasremisionesdetalles.idremision=tblcomprasremisiones.idremision where (tblcomprasremisiones.estado=3) and  tblcomprasremisiones.fecha<=pfecha1 and tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisionesdetalles.cantidad<>0 and tblcomprasremisiones.usado=0),0);
set vcosto2=ifnull((select if(tblmovimientosdetalles.idmoneda=2,max(tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad),max((tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad)*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where (tipo=0 or tipo=4) and estado=3 and  fecha<=pfecha1 and idinventario=pidinventario and tblmovimientosdetalles.cantidad<>0),0);
if vcosto2>vcosto then
set vcosto=vcosto2;
end if;
if vcosto3>vcosto then
set vcosto=vcosto3;
end if;

end if;

update tblinventarioprecios inner join tblinventario on tblinventarioprecios.idinventario=tblinventario.idinventario
set tblinventarioprecios.precio=vcosto*(1+tblinventarioprecios.utilidad/100)
where tblinventarioprecios.idinventario=pidinventario and tblinventarioprecios.utilidad<>0;

return ifnull(vcosto,0);



END $$

DELIMITER ;

insert into tblactualizaciones values('ver 9009 beta 5');

ALTER TABLE `tblcajas` ADD COLUMN `serie` VARCHAR(20) NOT NULL AFTER `idsucursal`;
ALTER TABLE `tblcajas` ADD COLUMN `deposito` DOUBLE NOT NULL AFTER `serie`;
ALTER TABLE `tblcajas` ADD COLUMN `seriecot` VARCHAR(20) NOT NULL AFTER `deposito`,
 ADD COLUMN `serieped` VARCHAR(20) NOT NULL AFTER `seriecot`;
insert into tblactualizaciones values('ver 9010 beta 1');

