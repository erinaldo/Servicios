DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
end if;
end if;


/********************************************************************/
/********************************************************************/
/****************************************************************/

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


return vcantidad;



END $$

DELIMITER ;



DELIMITER $$

DROP FUNCTION IF EXISTS `spdadetalleskit` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdadetalleskit`(pidocumento int,piddetalle int,pconseries tinyint,ptipo int) RETURNS varchar(2000) CHARSET utf8
BEGIN
declare varminid int;
declare varmaxid int;
declare varidinventario int;
declare varidventa int;
declare vardetalles varchar(2000);
set vardetalles='';
if ptipo=0 then
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskits where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskits where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskits on tblventaskits.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskits on tblventaskits.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
if pconseries=1 then
set varidinventario=(select idinventario from tblventaskits where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskits where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;
set varminid=ifnull((select min(iddetallekit) from tblventaskits where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;


if ptipo=1 then /*remision*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsr where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsr where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsr where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskitsr on tblventaskitsr.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsr on tblventaskitsr.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsr where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

if ptipo=2 then /*pedido*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsp where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsp where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsp where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskitsp on tblventaskitsp.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsp on tblventaskitsp.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsp where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

if ptipo=3 then /*cotizacion*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsc where iddetalle=piddetalle),0);
set varmaxid=ifnull((select max(iddetallekit) from tblventaskitsc where iddetalle=piddetalle),0);

while varminid<=varmaxid and varminid<>0 do
set vardetalles=concat(vardetalles,'\n',convert((select cantidad from tblventaskitsc where iddetallekit=varminid limit 1) using utf8),' ',(select tblinventario.clave from tblinventario inner join tblventaskitsc on tblventaskitsc.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1),' ',(select tblinventario.nombre from tblinventario inner join tblventaskitsc on tblventaskitsc.idinventario=tblinventario.idinventario where iddetallekit=varminid limit 1));
/*if pconseries=1 then
set varidinventario=(select idinventario from tblventaskitsr where iddetallekit=varminid);
set varidventa=(select idventa from tblventaskitsr where iddetallekit=varminid);
set vardetalles=concat(vardetalles,(select spdaseriesventa(varidinventario,varidventa)));
end if;*/
set varminid=ifnull((select min(iddetallekit) from tblventaskitsc where iddetalle=piddetalle and iddetallekit>varminid),0);

end while;
end if;

return vardetalles;
END $$

DELIMITER ;

ALTER TABLE `tblimpresionesnodos` ADD COLUMN `renglon` TINYINT UNSIGNED NOT NULL AFTER `nombre`;
update tblimpresionesnodos set renglon=0;

CREATE TABLE `tblventasimpuestos` (
  `idimpuesto` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(450) NOT NULL,
  `idventa` INTEGER UNSIGNED NOT NULL,
  `tipo` TINYINT UNSIGNED NOT NULL,
  `tasa` DOUBLE NOT NULL,
  PRIMARY KEY (`idimpuesto`)
)
ENGINE = InnoDB;

ALTER TABLE `tblclientes` ADD COLUMN `activarimpuestos` TINYINT UNSIGNED NOT NULL AFTER `saldoafavor`;

insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(159,888,'Total sin ret.','totalsil',120,16,'Lucida Console',8,0,0,0,1,0,0,1,0,1,'TotalSinIL',0);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(159,888,'Total sin ret.','totalsil',120,16,'Lucida Console',8,0,0,0,1,0,16,1,0,1,'TotalSinIL',0);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(13,703,'Total letra','totalletrasil',500,50,'Lucida Console',8,0,0,0,0,0,0,1,0,0,'Total letra sin Imp',0);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon) values(13,703,'Total letra','totalletrasil',500,50,'Lucida Console',8,0,0,0,0,0,16,1,0,0,'Total letra sin Imp',0);

insert into tblactualizaciones values('ver 9014 rev 6');