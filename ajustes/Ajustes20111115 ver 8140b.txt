DELIMITER $$

DROP FUNCTION IF EXISTS `spclientesmovimientos` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spclientesmovimientos`(pidcliente int,pfecha1 varchar(10),pfecha2 varchar(10)) RETURNS int(11)
BEGIN

delete from tblclientesmovimientos where idcliente=pidcliente;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,2,idnota,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,hora,3,serie,folio from tblnotasdecredito where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,3,iddevolucion,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,hora,3,serie,folio from tbldevoluciones where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidcliente,tblventaspagos.hora,3,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidcliente,tblventaspagos.hora,3,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidcliente,tblventaspagos.hora,3,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,5,idcargo,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,serie,folio from tblnotasdecargo where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,6,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,seriereferencia,folioreferencia from tbldocumentosclientes where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,7,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,hora,3,serie,folio from tbldocumentosclientes where idcliente=pidcliente and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=0;

/*Cancelados**************************************************/

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,2,idnota,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,horacancelado,4,serie,folio from tblnotasdecredito where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,3,iddevolucion,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,pidcliente,horacancelado,4,serie,folio from tbldevoluciones where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

/*
insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.hora,4,if(tblventaspagos.idventa<>0,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1),(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1)) as serie,
if(tblventaspagos.idventa<>0,(select folio from tblventas where idventa=tblventaspagos.idventa limit 1),(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1)) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0;
*/

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.horacancelado,4,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.horacancelado,4,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.horacancelado,4,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;



insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,5,idcargo,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tblnotasdecargo where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,6,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,seriereferencia,folioreferencia from tbldocumentosclientes where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,7,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidcliente,horacancelado,4,serie,folio from tbldocumentosclientes where idcliente=pidcliente and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=0;








return pidcliente;
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spclientesmovimientostodos` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spclientesmovimientostodos`(pfecha1 varchar(10),pfecha2 varchar(10)) RETURNS int(11)
BEGIN

delete from tblclientesmovimientos;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,hora,3,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,2,idnota,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,hora,3,serie,folio from tblnotasdecredito where  (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,3,iddevolucion,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,hora,3,serie,folio from tbldevoluciones where  (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,idcliente,tblventaspagos.hora,3,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where  (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,idcliente,tblventaspagos.hora,3,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where  (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,idcliente,tblventaspagos.hora,3,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where (tblventaspagos.estado=3 or tblventaspagos.estado=4) and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;


insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,5,idcargo,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,serie,folio from tblnotasdecargo where  (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,6,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,seriereferencia,folioreferencia from tbldocumentosclientes where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fecha,7,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,hora,3,serie,folio from tbldocumentosclientes where (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=0;

/*Cancelado***************************************************/

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,1,idventa,if(idconversion=2,totalapagar,totalapagar*tipodecambio),if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblventas inner join tblformasdepago on tblventas.idforma=tblformasdepago.idforma where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,2,idnota,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,horacancelado,4,serie,folio from tblnotasdecredito where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,3,iddevolucion,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,idcliente,horacancelado,4,serie,folio from tbldevoluciones where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

/*
insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fecha,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidcliente,tblventaspagos.hora,4,if(tblventaspagos.idventa<>0,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1),(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1)) as serie,
if(tblventaspagos.idventa<>0,(select folio from tblventas where idventa=tblventaspagos.idventa limit 1),(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1)) as folio from tblventaspagos where tblventaspagos.idcliente=pidcliente and tblventaspagos.estado=4 and tblventaspagos.fecha>=pfecha1 and tblventaspagos.fecha<=pfecha2 and tblventaspagos.iddocumento=0;
*/

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,idcliente,tblventaspagos.horacancelado,4,(select serie from tblventas where idventa=tblventaspagos.idventa limit 1) as serie,
(select folio from tblventas where idventa=tblventaspagos.idventa limit 1) as folio from tblventaspagos where  tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idventa<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,idcliente,tblventaspagos.horacancelado,4,(select serie from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as serie,
(select folio from tblnotasdecargo where idcargo=tblventaspagos.idcargo limit 1) as folio from tblventaspagos where tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.idcargo<>0;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select tblventaspagos.fechacancelado,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,idcliente,tblventaspagos.horacancelado,4,(select if(tiposaldo=0,serie,seriereferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as serie,
(select if(tiposaldo=0,folio,folioreferencia) from tbldocumentosclientes where iddocumento=tblventaspagos.iddocumentod limit 1) as folio from tblventaspagos where tblventaspagos.estado=4 and tblventaspagos.fechacancelado>=pfecha1 and tblventaspagos.fechacancelado<=pfecha2 and tblventaspagos.iddocumento=0 and tblventaspagos.iddocumentod<>0;



insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,5,idcargo,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tblnotasdecargo where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,6,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,seriereferencia,folioreferencia from tbldocumentosclientes where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=1;

insert into tblclientesmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idcliente,hora,estado,serie,folio)
select fechacancelado,7,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,idcliente,horacancelado,4,serie,folio from tbldocumentosclientes where estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=0;








return 0;
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spproveedoresmovimientos` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spproveedoresmovimientos`(pidproveedor int,pfecha1 varchar(10),pfecha2 varchar(10)) RETURNS int(11)
BEGIN

delete from tblproveedoresmovimientos where idproveedor=pidproveedor;


insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fecha,1,idcompra,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidproveedor,hora,3,referencia from tblcompras inner join tblformasdepago on tblcompras.idforma=tblformasdepago.idforma where idproveedor=pidproveedor and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=0;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fecha,1,idcompra,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,hora,3,referencia from tblcompras inner join tblformasdepago on tblcompras.idforma=tblformasdepago.idforma where idproveedor=pidproveedor and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tblformasdepago.tipo=1;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fecha,2,idnota,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,hora,3,folio from tblnotasdecreditocompras where idproveedor=pidproveedor and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fecha,3,iddevolucion,0,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,hora,3,folio from tbldevolucionescompras where idproveedor=pidproveedor and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select tblcompraspagos.fecha,4,idpago,0,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,pidproveedor,tblcompraspagos.hora,3,
if(tblcompraspagos.idcompra<>0,(select referencia from tblcompras where idcompra=tblcompraspagos.idcompra limit 1),(select folio from tblnotasdecargocompras where idcargo=tblcompraspagos.idcargo limit 1)) as folio from tblcompraspagos where tblcompraspagos.idproveedor=pidproveedor and (tblcompraspagos.estado=3 or tblcompraspagos.estado=4) and tblcompraspagos.fecha>=pfecha1 and tblcompraspagos.fecha<=pfecha2 and tblcompraspagos.iddocumento=0;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fecha,5,idcargo,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidproveedor,hora,3,folio from tblnotasdecargocompras where idproveedor=pidproveedor and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fecha,6,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidproveedor,hora,3,concat(seriereferencia,convert(folioreferencia using utf8)) from tbldocumentosproveedores where idproveedor=pidproveedor and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=1;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fecha,7,iddocumento,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidproveedor,hora,3,concat(serie,convert(folio using utf8)) from tbldocumentosproveedores where idproveedor=pidproveedor and (estado=3 or estado=4) and fecha>=pfecha1 and fecha<=pfecha2 and tiposaldo=0;

/*Cancelado*******************************************************************/

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fechacancelado,1,idcompra,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,horacancelado,4,referencia from tblcompras inner join tblformasdepago on tblcompras.idforma=tblformasdepago.idforma where idproveedor=pidproveedor and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=0;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fechacancelado,1,idcompra,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,horacancelado,4,referencia from tblcompras inner join tblformasdepago on tblcompras.idforma=tblformasdepago.idforma where idproveedor=pidproveedor and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tblformasdepago.tipo=1;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fechacancelado,2,idnota,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,0,pidproveedor,horacancelado,4,folio from tblnotasdecreditocompras where idproveedor=pidproveedor and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fechacancelado,3,iddevolucion,if(idconversion=2,totalapagar,totalapagar*tipodecambio),0,0,pidproveedor,horacancelado,4,folio from tbldevolucionescompras where idproveedor=pidproveedor and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;


insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select tblcompraspagos.fecha,4,idpago,if(idmoneda=2,cantidad,cantidad*ptipodecambio),0,0,pidproveedor,tblcompraspagos.hora,4,
if(tblcompraspagos.idcompra<>0,(select referencia from tblcompras where idcompra=tblcompraspagos.idcompra limit 1),(select folio from tblnotasdecargocompras where idcargo=tblcompraspagos.idcargo limit 1)) as folio from tblcompraspagos where tblcompraspagos.idproveedor=pidproveedor and tblcompraspagos.estado=4 and tblcompraspagos.fechacancelado>=pfecha1 and tblcompraspagos.fechacancelado<=pfecha2 and tblcompraspagos.iddocumento=0;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fechacancelado,5,idcargo,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,horacancelado,4,folio from tblnotasdecargocompras where idproveedor=pidproveedor and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fechacancelado,6,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,horacancelado,4,concat(seriereferencia,convert(folioreferencia using utf8)) from tbldocumentosproveedores where idproveedor=pidproveedor and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=1;

insert into tblproveedoresmovimientos(fecha,tipomovimiento,iddocumento,cargo,abono,saldo,idproveedor,hora,estado,folio)
select fechacancelado,7,iddocumento,0,if(idmoneda=2,totalapagar,totalapagar*tipodecambio),0,pidproveedor,horacancelado,4,concat(serie,convert(folio using utf8)) from tbldocumentosproveedores where idproveedor=pidproveedor and estado=4 and fechacancelado>=pfecha1 and fechacancelado<=pfecha2 and tiposaldo=0;
return pidproveedor;
END $$

DELIMITER ;



DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN

delete from tblinventariomovimientosk where idinventario=pidinventario;
/*0 inventario inicial 1 entrada 2 salida 3 traspaso 4 recepcion 5 compra 6 devolucion compra 7 remision compra 8 venta 9 devolucion venta 10 remision venta 11 ajuste*/
/*inventario inicial*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

/*1 Entradas*/

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


/*2 Salidas*/

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


/*3 Traspaso*/

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

/*4 Recepcion*/
if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;

/*5 Compras*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,tblcomprasdetalles.precio,tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,tblcomprasdetalles.precio,tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,tblcomprasdetalles.precio,tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4);
end if;
end if;

/*6 Devoluciones Compras*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;

/*7 Remisiones Compras*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4) and tblcomprasremisiones.usado=0;
end if;
end if;


/*8 Ventas*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad,tblventasinventario.costo,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad,tblventasinventario.costo,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad,tblventasinventario.costo,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen;
end if;
end if;

/*9 Ventas devoluciones*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad,0,tbldevolucionesdetalles.costo,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad,0,tbldevolucionesdetalles.costo,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad,0,tbldevolucionesdetalles.costo,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;

/*10 ventas remisiones*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad,tblventasremisionesinventario.costo,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad,tblventasremisionesinventario.costo,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad,tblventasremisionesinventario.costo,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen;
end if;
end if;


/*11 inventario fsico*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

/******************************************/
/*******************************************/
/************Canceladas**********************/



/*inventario inicial*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

/*1 Entradas*/

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


/*2 Salidas*/

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


/*3 Traspaso*/

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

/*4 Recepcion*/
if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;

/*5 Compras*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,tblcomprasdetalles.precio,tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,tblcomprasdetalles.precio,tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,tblcomprasdetalles.precio,tblcomprasdetalles.idalmacen,0
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4;
end if;
end if;

/*6 Devoluciones Compras*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.idalmacen,0
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;

/*7 Remisiones Compras*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio,tblcomprasremisionesdetalles.idalmacen,0
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0;
end if;
end if;


/*8 Ventas*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad,0,tblventasinventario.costo,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad,0,tblventasinventario.costo,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad,0,tblventasinventario.costo,tblventasinventario.idalmacen,0
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen;
end if;
end if;

/*9 Ventas devoluciones*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad,tbldevolucionesdetalles.costo,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad,tbldevolucionesdetalles.costo,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad,tbldevolucionesdetalles.costo,tbldevolucionesdetalles.idalmacen,0
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;

/*10 ventas remisiones*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad,0,tblventasremisionesinventario.costo,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad,0,tblventasremisionesinventario.costo,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisiones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad,0,tblventasremisionesinventario.costo,tblventasremisionesinventario.idalmacen,0
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.usado=0 and tblventasremisionesinventario.idalmacen=pidalmacen;
end if;
end if;


/*11 inventario fsico*/
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,tblmovimientosdetalles.precio,tblmovimientosdetalles.idalmacen,0
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;

return 1;
END $$

DELIMITER ;