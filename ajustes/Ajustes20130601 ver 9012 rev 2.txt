DELIMITER $$

DROP PROCEDURE IF EXISTS `spanalisisinventariob` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spanalisisinventariob`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidalmacen int,pidsucursal int,pfecha3 varchar(10))
BEGIN
delete from tblinventariomovimientosb;
if pidsucursal<=0 then
  if pidalmacen<=0 then
    if pidinventario<=1 then

/* Todas sucursales todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


    else
/* Todas sucursales todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;
  else

    if pidinventario=0 then
/* Todas sucursales un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* Todas sucursales un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventasinventario.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;

    end if;

  end if;
else
  if pidalmacen<=0 then
    if pidinventario<=1 then
/* una sucursal todos los almacenes todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;

    else
/* una sucursal todos los almacenes un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevoluciones.idsucursal=pidsucursal),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientos.idsucursal=pidsucursal),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidinventario;


    end if;
  else

    if pidinventario<=1 then
/* una sucursal un almacen todos los articulos*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario>1;


      else
/* Una sucursal un almacen un articulo*/
insert into tblinventariomovimientosb(idinventario,compras,comprasdev,ventas,ventasdev,entradas,salidas,ajustes,costo,cantidad,costocompras,costocomprasd,costomoventradas,costodev,costomovsalidas,costoinicial,costofinal,ventascancelacion,costoventacancelacion,comprascancelacion,costocomprascancelacion,inventarioinicial,costoinicialb)
select tblinventario.idinventario,
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetallesc.cantidad) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
0,
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fecha order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and (tblventas.estado=3 or tblventas.estado=4) and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha3,pidalmacen,pidsucursal),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and (tblcompras.estado=3 or tblcompras.estado=4) and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio,tbldevolucionesdetallesc.precio*tbldevolucionescompras.tipodecambio)) from tbldevolucionesdetallesc inner join tbldevolucionescompras on tbldevolucionesdetallesc.iddevolucion=tbldevolucionescompras.iddevolucion where tbldevolucionesdetallesc.idinventario=tblinventario.idinventario and tbldevolucionescompras.estado=3 and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio,tblmovimientosdetalles.precio*tblmovimientos.tipodecambio)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and (tblinventarioconceptos.tipo=0 or tblinventarioconceptos.tipo=4) and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tbldevolucionesdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tbldevolucionesdetalles.idinventario and fecha<=tbldevoluciones.fecha order by fecha desc limit 1)) from tbldevolucionesdetalles inner join tbldevoluciones on tbldevolucionesdetalles.iddevolucion=tbldevoluciones.iddevolucion where tbldevolucionesdetalles.idinventario=tblinventario.idinventario and tbldevoluciones.estado=3 and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and tbldevolucionesdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(tblmovimientosdetalles.cantidad*(select costo from tblinventariocostoh where idinventario=tblmovimientosdetalles.idinventario and fecha<=tblmovimientos.fecha order by fecha desc limit 1)) from tblmovimientosdetalles inner join tblmovimientos on tblmovimientosdetalles.idmovimiento=tblmovimientos.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto where tblmovimientosdetalles.idinventario=tblinventario.idinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.estado=3 and tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and tblmovimientosdetalles.idalmacen=pidalmacen),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<pfecha1 order by fecha desc limit 1),0),
ifnull((select costo from tblinventariocostoh where idinventario=tblinventario.idinventario and fecha<=pfecha2 order by fecha desc limit 1),0),
ifnull((select sum(tblventasinventario.cantidad) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblventasinventario.cantidad*(select costo from tblinventariocostoh where idinventario=tblventasinventario.idinventario and fecha<=tblventas.fechacancelado order by fecha desc limit 1)) from tblventasinventario inner join tblventas on tblventasinventario.idventa=tblventas.idventa where tblventasinventario.idinventario=tblinventario.idinventario and tblventas.estado=4 and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0),0),
ifnull((select sum(tblcomprasdetalles.cantidad) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull((select sum(if(tblcomprasdetalles.idmoneda=2,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio,tblcomprasdetalles.costoindirecto+tblcomprasdetalles.precio*tblcompras.tipodecambio)) from tblcomprasdetalles inner join tblcompras on tblcomprasdetalles.idcompra=tblcompras.idcompra where tblcomprasdetalles.idinventario=tblinventario.idinventario and tblcompras.estado=4 and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen),0),
ifnull(spdainventarioafecha(tblinventario.idinventario,pfecha1,pidalmacen,pidsucursal),0),
0
 from tblinventario where tblinventario.idinventario=pidalmacen;

    end if;
  end if;
end if;



END $$

DELIMITER ;