DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;







if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and tblventasapartados.estado=4 and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;

return 1;
END $$

DELIMITER ;


CREATE TABLE `tblmtctemp` (
  `color` VARCHAR(45) NOT NULL,
  `talla` VARCHAR(45) NOT NULL,
  `codigoc` VARCHAR(45) NOT NULL,
  `codigot` VARCHAR(45) NOT NULL
)
ENGINE = InnoDB;

CREATE TABLE `tblinventariopreciostemp` (
  `id` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `idinventario` INTEGER UNSIGNED NOT NULL,
  `precio` DOUBLE NOT NULL,
  `comentario` VARCHAR(45) NOT NULL,
  `idmoneda` INTEGER UNSIGNED NOT NULL,
  `idlista` INTEGER UNSIGNED NOT NULL,
  `utilidad` DOUBLE NOT NULL,
  PRIMARY KEY (`id`)
)
ENGINE = InnoDB;

insert into tblinventariopreciostemp(idinventario,precio,comentario,idmoneda,idlista,utilidad) values(0,0,'',2,1,0);
insert into tblinventariopreciostemp(idinventario,precio,comentario,idmoneda,idlista,utilidad) values(0,0,'',2,2,0);
insert into tblinventariopreciostemp(idinventario,precio,comentario,idmoneda,idlista,utilidad) values(0,0,'',2,3,0);
insert into tblinventariopreciostemp(idinventario,precio,comentario,idmoneda,idlista,utilidad) values(0,0,'',2,4,0);
insert into tblinventariopreciostemp(idinventario,precio,comentario,idmoneda,idlista,utilidad) values(0,0,'',2,5,0);

CREATE TABLE `tblventasaduana` (
  `idaduana` INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
  `iddetalle` INTEGER UNSIGNED NOT NULL,
  `numero` VARCHAR(45) NOT NULL,
  `fecha` VARCHAR(10) NOT NULL,
  `aduana` VARCHAR(250) NOT NULL,
  PRIMARY KEY (`idaduana`)
)
ENGINE = InnoDB;

insert into tblactualizaciones values('ver 9015 rev 6');