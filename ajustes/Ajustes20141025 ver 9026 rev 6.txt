DROP TABLE IF EXISTS `tblfertillizantespedidosdetalles`;
CREATE TABLE  `tblfertilizantespedidosdetalles` (
  `iddetalle` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `idpedido` int(10) unsigned NOT NULL,
  `idinventario` int(10) unsigned NOT NULL,
  `cantidad` double NOT NULL,
  `precio` double NOT NULL,
  `descripcion` varchar(1000) NOT NULL,
  `idmoneda` int(10) unsigned NOT NULL,
  `iva` double NOT NULL,
  `descuento` double NOT NULL,
  `surtido` double NOT NULL,
  `preciooriginal` double NOT NULL,
  `ieps` double NOT NULL,
  `ivaretenido` double NOT NULL,
  `hectareas` double NOT NULL,
  `cantxhec` double NOT NULL,
  PRIMARY KEY (`iddetalle`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

UPDATE tblpolizasdetalles SET idProveedor ="0";
ALTER TABLE `tblpolizasdetalles` MODIFY COLUMN `idProveedor` INTEGER UNSIGNED NOT NULL;

ALTER TABLE `tblfertilizantesmovimientos` ADD COLUMN `fecha` VARCHAR(10) NOT NULL AFTER `idinventario`;

delete from tblimpresionesnodos where documento=43 and idsucursal=1;
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(246,10,'Empresa','nombrefiscal',500,20,'Arial',10,1,0,0,0,1,43,1,0,0,'Documento - Empresa',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(246,31,'Calle - Empresa','direccion',150,20,'Arial',10,0,0,0,0,1,43,1,0,0,'Empresa - Calle',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(397,31,'No. Exterior - Empresa','noexterior',220,20,'Arial',10,0,0,0,0,1,43,1,0,0,'Empresa - No. Exterior',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(622,7,'No. Interior - Empresa','nointerior',220,20,'Lucida Console',8,0,0,0,0,0,43,1,0,0,'Empresa - No. Interior',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(246,52,'Col:','colonia',160,20,'Arial',10,0,0,0,0,1,43,1,0,1,'Empresa - Colonia',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(407,52,'Ciudad - Empresa','ciudad',160,20,'Arial',10,0,0,0,0,1,43,1,0,0,'Empresa - Ciudad',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(567,52,'Estado - Empresa','estado',160,20,'Arial',10,0,0,0,0,1,43,1,0,0,'Empresa - Estado',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(246,72,'C.P:','cp',80,20,'Arial',10,0,0,0,0,1,43,1,0,1,'Empresa - CP',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(327,72,'RFC:','rfc',130,20,'Arial',10,0,0,0,0,1,43,1,0,1,'Empresa - RFC',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(458,72,'Tel:','tel',180,20,'Arial',10,0,0,0,0,1,43,1,0,1,'Empresa - Teléfono',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(246,93,'Email - Empresa','email',400,20,'Arial',10,0,0,0,0,1,43,1,0,0,'Empresa - Email',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(624,31,'Referencia - Empresa','referencia',200,20,'Lucida Console',8,0,0,0,0,0,43,1,0,0,'Empresa - Referencia',0,2);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(14,163,'Cliente: ','nombrecliente',460,25,'Lucida Console',8,0,0,0,0,1,43,1,0,0,'Cliente - Nombre',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(14,185,'Calle:','direccioncliente',350,20,'Lucida Console',8,0,0,0,0,1,43,1,0,1,'Cliente - Calle',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(365,185,'No:','noexteriorcliente',150,20,'Lucida Console',8,0,0,0,0,1,43,1,0,1,'Cliente - No. Exterior',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(84,95,'No Int:','nointeriorcliente',150,20,'Lucida Console',8,0,0,0,0,0,43,1,0,0,'Cliente - No. Interior',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(14,200,'Colonia:','coloniacliente',230,20,'Lucida Console',8,0,0,0,0,1,43,1,0,1,'Cliente - Colonia',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(245,200,'CP:','cpcliente',120,20,'Lucida Console',8,0,0,0,0,1,43,1,0,1,'Cliente - CP',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(14,217,'Ciudad:','ciudadcliente',140,20,'Lucida Console',8,0,0,0,0,1,43,1,0,0,'Cliente - Ciudad',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(156,217,'Estado:','estadocliente',160,20,'Lucida Console',8,0,0,0,0,1,43,1,0,0,'Cliente - Estado',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(360,217,'RFC:','rfccliente',150,20,'Lucida Console',8,0,0,0,0,1,43,1,0,0,'Cliente - RFC',0,3);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(662,117,'Serie','serie',50,20,'Arial',8,0,0,0,0,1,43,1,0,0,'Documento - Serie',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(713,117,'Folio','folio',100,20,'Arial',8,0,0,0,0,1,43,1,0,0,'Documento - Folio',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Fecha','fecha',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Fecha',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(764,141,'Hora','hora',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Hora',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Tipo Movimiento:','tipomov',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Tipo Mov',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Almacen:','almacen',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Almacen Origen',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Almacen Destino:','almacendest',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Almacen Destino',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Estado:','estados',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Estado',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Peso Bruto:','pesobruto',100,20,'Microsoft Sans Serif',10,0,0,0,1,1,43,1,0,0,'Documento - Peso Bruto',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Tara:','tara',100,20,'Microsoft Sans Serif',10,0,0,0,1,1,43,1,0,0,'Documento - Tara',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Peso Neto','pesoneto',100,20,'Microsoft Sans Serif',10,0,0,0,1,1,43,1,0,0,'Documento - Peso Neto',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Peso Bruto 2:','pesobruto2',100,20,'Microsoft Sans Serif',10,0,0,0,1,1,43,1,0,0,'Documento - Peso Bruto 2',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Consumo total:','consumo',100,20,'Microsoft Sans Serif',10,0,0,0,1,1,43,1,0,0,'Documento - Consumo',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Importe Neto:','importeneto',100,20,'Microsoft Sans Serif',10,0,0,0,1,1,43,1,0,0,'Documento - Importe Neto',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Importe Consumo:','importeconsumo',100,20,'Microsoft Sans Serif',10,0,0,0,1,1,43,1,0,0,'Documento - Importe consumo',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Fecha Carga:','fechacarga',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Fecha Carga',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Hora Carga:','horacarga',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Hora Carga',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Fecha Regreso:','fecharegreso',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Fecha Regreso',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Hora Regreso:','horaregreso',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Hora Regreso',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Fecha Envío:','fechaenvio',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Fecha Envío',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Fecha Descarga:','fechadescarga',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Fecha Descarga',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Chofer:','chofer',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Chofer',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Inspecto:','inspector',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Inspector',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Vehículo:','vehiculo',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Vehículo',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Placas:','placas',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Placas',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Block Lotes:','blocklotes',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Block Lotes',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Cultivo:','cultivo',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - cultivo',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Producto:','producto',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Producto',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Código:','codigo',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Código',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Estado Surtido:','estadosurtido',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Estado Surtido',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(663,141,'Viene de Pedido No:','pedidono',100,20,'Microsoft Sans Serif',10,0,0,0,0,1,43,1,0,0,'Documento - Pedido No.',0,1);
insert into tblimpresionesnodos(x,y,texto,datapropertyname,xl,yl,fuente,fuentesize,fuentestilo,alineacion,tipo,tipodato,visible,documento,idsucursal,tiponodo,conetiqueta,nombre,renglon,clasificacion) values(324,492,'Mensaje Cancelado','cancelado',170,20,'Arial',18,0,0,1,0,1,43,1,0,0,'Documento - Mensaje Cancelado',0,1);
ALTER TABLE `tblfertilizantespedidosdetalles` ADD CONSTRAINT `FK_tblfertilizantespedidosdetalles_1` FOREIGN KEY `FK_tblfertilizantespedidosdetalles_1` (`idpedido`)
    REFERENCES `tblfertilizantespedidos` (`idpedido`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION;

ALTER TABLE `tblfertilizantesmovimientos` ADD COLUMN `estadosurtido` TINYINT UNSIGNED NOT NULL AFTER `fecha`;
ALTER TABLE `tblfertilizantesmovimientos` ADD COLUMN `fechacancelado` VARCHAR(10) NOT NULL AFTER `estadosurtido`,
 ADD COLUMN `horacancelado` VARCHAR(8) NOT NULL AFTER `fechacancelado`;

ALTER TABLE `tblzona` MODIFY COLUMN `zona` VARCHAR(450) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;

DELIMITER $$

DROP FUNCTION IF EXISTS `spinventariomovimientosk` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spinventariomovimientosk`(pidinventario int,pfecha1 varchar(10),pfecha2 varchar(10),pidsucursal int,pidalmacen int) RETURNS int(11)
BEGIN
declare varcontenido decimal(16,4);

set varcontenido=(select contenido from tblinventario where idinventario=pidinventario);
delete from tblinventariomovimientosk where idinventario=pidinventario;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,0,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,1,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,2,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,
if(tblmovimientos.idventa<>0,(select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblmovimientos.idventa),if(tblmovimientos.idremision<>0,(select concat(tblventasremisiones.serie,convert(tblventasremisiones.folio using utf8)) from tblventasremisiones where tblventasremisiones.idremision=tblmovimientos.idremision),'')),if(tblmovimientos.idventa<>0,'F',if(tblmovimientos.idremision<>0,'R',''))
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,3,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,4,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(round(tblmovimientosdetalles.cantidad,2)<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fecha,tblcompras.hora,5,tblcompras.idcompra,3,tblcompras.serie,tblcompras.folioi,tblcomprasdetalles.cantidad,0,if(round(tblcomprasdetalles.cantidad,2)<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,
ifnull((select concat(tblcomprasremisiones.serie,convert(tblcomprasremisiones.folio using utf8)) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra limit 1),''),''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha>=pfecha1 and tblcompras.fecha<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2),if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fecha,tbldevolucionescompras.hora,6,tbldevolucionescompras.iddevolucion,3,tbldevolucionescompras.folio,0,0,tbldevolucionesdetallesc.cantidad,if(round(tbldevolucionesdetallesc.cantidad,2)<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha>=pfecha1 and tbldevolucionescompras.fecha<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4);
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fecha,tblcomprasremisiones.hora,7,tblcomprasremisiones.idremision,3,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,tblcomprasremisionesdetalles.cantidad,0,if(round(tblcomprasremisionesdetalles.cantidad,2)<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha>=pfecha1 and tblcomprasremisiones.fecha<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4);
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventasinventario.cantidad/varcontenido,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fecha,tblventas.hora,8,tblventas.idventa,3,tblventas.serie,tblventas.folio,0,tblventaskits.cantidad/varcontenido,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha>=pfecha1 and tblventas.fecha<=pfecha2 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4);
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fecha,tbldevoluciones.hora,9,tbldevoluciones.iddevolucion,3,tbldevoluciones.serie,tbldevoluciones.folio,tbldevolucionesdetalles.cantidad/varcontenido,0,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha>=pfecha1 and tbldevoluciones.fecha<=pfecha2 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventasremisionesinventario.cantidad/varcontenido,0,tblventasremisionesinventario.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;

if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fecha,tblventasremisiones.hora,10,tblventasremisiones.idremision,3,tblventasremisiones.serie,tblventasremisiones.folio,0,tblventaskitsr.cantidad/varcontenido,0,tblventaskitsr.idalmacen,0,
ifnull((select concat(tblventas.serie,convert(tblventas.folio using utf8)) from tblventas where tblventas.idventa=tblventasremisiones.idventar limit 1),''),''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha>=pfecha1 and tblventasremisiones.fecha<=pfecha2 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior*-1,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fecha,tblmovimientos.hora,11,tblmovimientos.idmovimiento,3,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha>=pfecha1 and tblmovimientos.fecha<=pfecha2 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fecha,tblventasapartados.hora,12,tblventasapartados.idapartado,3,tblventasapartados.serie,tblventasapartados.folio,0,tblventasapartadosdetalles.cantidad/varcontenido,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha>=pfecha1 and tblventasapartados.fecha<=pfecha2 and (tblventasapartados.estado=3 or tblventasapartados.estado=4) and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;

#Fertilizantes Salida
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,2,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.surtido,0,tblfertilizantesmovimientos.idalmacen,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo<>2;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,2,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.surtido,0,tblfertilizantesmovimientos.idalmacen,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,2,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.surtido,0,tblfertilizantesmovimientos.idalmacen,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacen=pidalmacen and tblfertilizantesmovimientos.tipo<>2;
end if;
end if;


#fertilizantes traspaso
if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,3,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.pesoneto,0,tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,3,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.pesoneto,0,tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacen=pidalmacen;
end if;
end if;


#fertilizantes recepción
if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,4,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.pesoneto,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fecha order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,4,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.pesoneto,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fecha order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen;
end if;
end if;

#Fertilizantes Salida cuando hubo traspaso
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,2,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.surtido,0,tblfertilizantesmovimientos.idalmacendestino,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo=2;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,2,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.surtido,0,tblfertilizantesmovimientos.idalmacendestino,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fecha,tblfertilizantesmovimientos.hora,2,tblfertilizantesmovimientos.idmovimiento,3,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.surtido,0,tblfertilizantesmovimientos.idalmacendestino,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha>=pfecha1 and tblfertilizantesmovimientos.fecha<=pfecha2 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen and tblfertilizantesmovimientos.tipo<>2;
end if;
end if;

#Canceladas
#--------------------------------------------------
#---------------------------------------------------


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,0,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,1,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,2,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;




if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,3,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.cantidad,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,4,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.cantidad,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,tblmovimientosdetalles.idalmacen2,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcompras.fechacancelado,tblcompras.horacancelado,5,tblcompras.idcompra,4,tblcompras.serie,tblcompras.folioi,0,tblcomprasdetalles.cantidad,if(tblcomprasdetalles.cantidad<>0,if(tblcomprasdetalles.idmoneda=2,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad,(tblcomprasdetalles.precio+tblcomprasdetalles.costoindirecto)/tblcomprasdetalles.cantidad*tblcompras.tipodecambio),0),tblcomprasdetalles.idalmacen,0,'',''
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado>=pfecha1 and tblcompras.fechacancelado<=pfecha2 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevolucionescompras.fechacancelado,tbldevolucionescompras.horacancelado,6,tbldevolucionescompras.iddevolucion,4,tbldevolucionescompras.folio,0,tbldevolucionesdetallesc.cantidad,0,if(tbldevolucionesdetallesc.cantidad<>0,if(tbldevolucionesdetallesc.idmoneda=2,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad,tbldevolucionesdetallesc.precio/tbldevolucionesdetallesc.cantidad*tbldevolucionescompras.tipodecambio),0),tbldevolucionesdetallesc.idalmacen,0,'',''
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado>=pfecha1 and tbldevolucionescompras.fechacancelado<=pfecha2 and tbldevolucionesdetallesc.idalmacen=pidalmacen and  tbldevolucionescompras.estado=4;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblcomprasremisiones.fechacancelado,tblcomprasremisiones.horacancelado,7,tblcomprasremisiones.idremision,4,tblcomprasremisiones.serie,tblcomprasremisiones.folioi,0,tblcomprasremisionesdetalles.cantidad,if(tblcomprasremisionesdetalles.cantidad<>0,if(tblcomprasremisionesdetalles.idmoneda=2,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad,tblcomprasremisionesdetalles.precio/tblcomprasremisionesdetalles.cantidad*tblcomprasremisiones.tipodecambio),0),tblcomprasremisionesdetalles.idalmacen,0,'',''
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado>=pfecha1 and tblcomprasremisiones.fechacancelado<=pfecha2 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventasinventario.cantidad/varcontenido,0,0,tblventasinventario.idalmacen,0,'',''
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and (select count(tblventasremisiones.idventar) from tblventasremisiones where tblventasremisiones.idventar=tblventas.idventa)=0;
end if;
end if;



if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventas.fechacancelado,tblventas.horacancelado,8,tblventas.idventa,4,tblventas.serie,tblventas.folio,tblventaskits.cantidad/varcontenido,0,0,tblventaskits.idalmacen,0,'',''
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado>=pfecha1 and tblventas.fechacancelado<=pfecha2 and  tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tbldevoluciones.fechacancelado,tbldevoluciones.horacancelado,9,tbldevoluciones.iddevolucion,4,tbldevoluciones.serie,tbldevoluciones.folio,0,tbldevolucionesdetalles.cantidad/varcontenido,0,tbldevolucionesdetalles.idalmacen,0,'',''
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado>=pfecha1 and tbldevoluciones.fechacancelado<=pfecha2 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventasremisionesinventario.cantidad/varcontenido,0,0,tblventasremisionesinventario.idalmacen,0,'',''
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasremisiones.fechacancelado,tblventasremisiones.horacancelado,10,tblventasremisiones.idremision,4,tblventasremisiones.serie,tblventasremisiones.folio,tblventaskitsr.cantidad/varcontenido,0,0,tblventaskitsr.idalmacen,0,'',''
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado>=pfecha1 and tblventasremisiones.fechacancelado<=pfecha2 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,0,tblmovimientosdetalles.inventarioanterior*-1,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen;

insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblmovimientos.fechacancelado,tblmovimientos.horacancelado,11,tblmovimientos.idmovimiento,4,tblmovimientos.serie,tblmovimientos.folio,tblmovimientosdetalles.inventarioanterior,0,if(tblmovimientosdetalles.cantidad<>0,if(tblmovimientosdetalles.idmoneda=2,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad,tblmovimientosdetalles.precio/tblmovimientosdetalles.cantidad*tblmovimientos.tipodecambio),0),tblmovimientosdetalles.idalmacen,0,'',''
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado>=pfecha1 and tblmovimientos.fechacancelado<=pfecha2 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen;
end if;
end if;


if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fechacancelado,tblventasapartados.horacancelado,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fechacancelado>=pfecha1 and tblventasapartados.fechacancelado<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fechacancelado,tblventasapartados.horacancelado,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fechacancelado>=pfecha1 and tblventasapartados.fechacancelado<=pfecha2 and tblventasapartados.estado=4 and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblventasapartados.fechacancelado,tblventasapartados.horacancelado,12,tblventasapartados.idapartado,4,tblventasapartados.serie,tblventasapartados.folio,tblventasapartadosdetalles.cantidad/varcontenido,0,0,tblventasapartadosdetalles.idalmacen,0,
'',''
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fechacancelado>=pfecha1 and tblventasapartados.fechacancelado<=pfecha2 and tblventasapartados.estado=4 and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtidodonde=0;
end if;
end if;


#Fertilizantes Salida
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,2,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.surtido,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fecha order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacen,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo<>2;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,2,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.surtido,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fecha order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacen,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,2,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.surtido,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fecha order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacen,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacen=pidalmacen and tblfertilizantesmovimientos.tipo<>2;
end if;
end if;

#fertilizantes recepción
if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,4,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.pesoneto,0,tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,4,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,0,tblfertilizantesmovimientos.pesoneto,0,tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen;
end if;
end if;

#fertilizantes traspaso
if pidsucursal>0 then
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,3,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.pesoneto,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fechacancelado order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,3,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.pesoneto,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fechacancelado order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacen,tblfertilizantesmovimientos.idalmacendestino,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacen=pidalmacen;
end if;
end if;


#Fertilizantes Salida cuando hubo traspaso
if pidsucursal<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,2,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.surtido,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fechacancelado order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacendestino,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo=2;
else
if pidalmacen<=0 then
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,2,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.surtido,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fechacancelado order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacendestino,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2;
else
insert into tblinventariomovimientosk(idinventario,fecha,hora,tipomovimiento,iddocumento,estado,serie,folio,entrada,salida,costo,idalmacen1,idalmacen2,folioref,tiporef)
select pidinventario,tblfertilizantesmovimientos.fechacancelado,tblfertilizantesmovimientos.horacancelado,2,tblfertilizantesmovimientos.idmovimiento,4,tblfertilizantesmovimientos.serie,tblfertilizantesmovimientos.folio,tblfertilizantesmovimientos.surtido,0,(select costo from tblinventariocostoh where idinventario=tblfertilizantesmovimientos.idinventario and fecha<=tblfertilizantesmovimientos.fechacancelado order by fecha desc limit 1),tblfertilizantesmovimientos.idalmacendestino,0,concat(tblfertilizantespedidos.serie,convert(tblfertilizantespedidos.folio using utf8)),''
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado>=pfecha1 and tblfertilizantesmovimientos.fechacancelado<=pfecha2 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen and tblfertilizantesmovimientos.tipo<>2;
end if;
end if;

return 1;
END $$

DELIMITER ;

DELIMITER $$

DROP FUNCTION IF EXISTS `spdainventarioafecha` $$
CREATE DEFINER=`root`@`localhost` FUNCTION `spdainventarioafecha`(pidinventario int,pfecha1 varchar(10),pidsucursal int,pidalmacen int) RETURNS double
BEGIN
declare vcantidad double;
declare vcontenido double;
set vcantidad=0;
set vcontenido=(select contenido from tblinventario where idinventario=pidinventario);
if vcontenido=0 then
set vcontenido=1;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4)  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcompras.idsucursal=pidsucursal and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fecha<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and (tblcompras.estado=3 or tblcompras.estado=4)
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fecha<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and (tbldevolucionescompras.estado=3 or tbldevolucionescompras.estado=4)),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fecha<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and (tblcomprasremisiones.estado=3 or tblcomprasremisiones.estado=4)),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fecha<pfecha1 and (tblventas.estado=3 or tblventas.estado=4) and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4)),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fecha<pfecha1 and (tbldevoluciones.estado=3 or tbldevoluciones.estado=4) and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fecha<pfecha1 and (tblventasremisiones.estado=3 or tblventasremisiones.estado=4) and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fecha<pfecha1 and (tblmovimientos.estado=3 or tblmovimientos.estado=4) and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartados.idsucursal=pidsucursal and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tblventasapartadosdetalles.cantidad)
from tblventasapartados inner join tblventasapartadosdetalles on tblventasapartados.idapartado=tblventasapartadosdetalles.idapartado
where tblventasapartadosdetalles.idinventario=pidinventario and tblventasapartados.fecha<pfecha1 and tblventasapartados.estado=3 and tblventasapartadosdetalles.idalmacen=pidalmacen and tblventasapartados.dinventario=1 and tblventasapartados.surtido=0),0)/vcontenido;
end if;
end if;




#Fertilizantes Salida menos
if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo<>2),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacen=pidalmacen and tblfertilizantesmovimientos.tipo<>2),0);
end if;
end if;


#fertilizantes traspaso
if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacen=pidalmacen),0);
end if;
end if;


#fertilizantes recepción
if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen),0);
end if;
end if;

#Fertilizantes Salida cuando hubo traspaso
if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo=2),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fecha<pfecha1 and (tblfertilizantesmovimientos.estado=3 or tblfertilizantesmovimientos.estado=4) and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen and tblfertilizantesmovimientos.tipo<>2),0);
end if;
end if;



#.............................
#---------------------------------------------------------------------
#Emipezan canceladas--------------------------------------------------
#------------------------------------------------


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=4 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4  and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=1 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;




if pidsucursal>0 then

if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto inner join tblalmacenes on tblalmacenes.idalmacen=tblmovimientosdetalles.idalmacen2 and tblalmacenes.idsucursal=tblmovimientos.idsucursal
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.cantidad)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=3 and tblmovimientosdetalles.idalmacen2=pidalmacen),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.estado=4
and tblcompras.deremision=0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcompras.idsucursal=pidsucursal and tblcompras.estado=4
and (select count(tblcomprasremisiones.idcomprar) from tblcomprasremisiones where tblcomprasremisiones.idcomprar=tblcompras.idcompra)=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasdetalles.cantidad)
from tblcompras inner join tblcomprasdetalles on tblcompras.idcompra=tblcomprasdetalles.idcompra
where tblcomprasdetalles.idinventario=pidinventario and tblcompras.fechacancelado<pfecha1 and tblcomprasdetalles.idalmacen=pidalmacen and tblcompras.estado=4
and tblcompras.deremision=0),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionescompras.idsucursal=pidsucursal and tbldevolucionescompras.estado=4),0);
else
set vcantidad=vcantidad+ifnull((select sum(tbldevolucionesdetallesc.cantidad)
from tbldevolucionescompras inner join tbldevolucionesdetallesc on tbldevolucionescompras.iddevolucion=tbldevolucionesdetallesc.iddevolucion
where tbldevolucionesdetallesc.idinventario=pidinventario and tbldevolucionescompras.fechacancelado<pfecha1 and tbldevolucionesdetallesc.idalmacen=pidalmacen and tbldevolucionescompras.estado=4),0);
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.estado=4),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisiones.idsucursal=pidsucursal and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblcomprasremisionesdetalles.cantidad)
from tblcomprasremisiones inner join tblcomprasremisionesdetalles on tblcomprasremisiones.idremision=tblcomprasremisionesdetalles.idremision
where tblcomprasremisionesdetalles.idinventario=pidinventario and tblcomprasremisiones.fechacancelado<pfecha1 and tblcomprasremisionesdetalles.idalmacen=pidalmacen and tblcomprasremisiones.estado=4 and tblcomprasremisiones.usado=0),0);
end if;
end if;



if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasinventario.cantidad)
from tblventas inner join tblventasinventario on tblventas.idventa=tblventasinventario.idventa
where tblventasinventario.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventasinventario.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventas.idsucursal=pidsucursal and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskits.cantidad)
from tblventas inner join tblventaskits on tblventas.idventa=tblventaskits.idventa
where tblventaskits.idinventario=pidinventario and tblventas.fechacancelado<pfecha1 and tblventas.estado=4 and tblventaskits.idalmacen=pidalmacen and tblventas.porsurtir=0
and tblventas.deremision=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevoluciones.idsucursal=pidsucursal),0)/vcontenido;
else
set vcantidad=vcantidad-ifnull((select sum(tbldevolucionesdetalles.cantidad)
from tbldevoluciones inner join tbldevolucionesdetalles on tbldevoluciones.iddevolucion=tbldevolucionesdetalles.iddevolucion
where tbldevolucionesdetalles.idinventario=pidinventario and tbldevoluciones.fechacancelado<pfecha1 and tbldevoluciones.estado=4 and tbldevolucionesdetalles.idalmacen=pidalmacen),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventasremisionesinventario.cantidad)
from tblventasremisiones inner join tblventasremisionesinventario on tblventasremisiones.idremision=tblventasremisionesinventario.idremision
where tblventasremisionesinventario.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisionesinventario.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;

if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventasremisiones.idsucursal=pidsucursal and tblventasremisiones.porsurtir=0),0)/vcontenido;
else
set vcantidad=vcantidad+ifnull((select sum(tblventaskitsr.cantidad)
from tblventasremisiones inner join tblventaskitsr on tblventasremisiones.idremision=tblventaskitsr.idremision
where tblventaskitsr.idinventario=pidinventario and tblventasremisiones.fechacancelado<pfecha1 and tblventasremisiones.estado=4 and tblventaskitsr.idalmacen=pidalmacen and tblventasremisiones.porsurtir=0),0)/vcontenido;
end if;
end if;


if pidsucursal<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientos.idsucursal=pidsucursal),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblmovimientosdetalles.inventarioanterior)*-1
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior<=0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);

set vcantidad=vcantidad+ifnull((select sum(tblmovimientosdetalles.inventarioanterior)
from tblmovimientos inner join tblmovimientosdetalles on tblmovimientos.idmovimiento=tblmovimientosdetalles.idmovimiento inner join tblinventarioconceptos on tblmovimientos.idconcepto=tblinventarioconceptos.idconcepto
where tblmovimientos.fechacancelado<pfecha1 and tblmovimientos.estado=4 and tblmovimientosdetalles.idinventario=pidinventario and tblinventarioconceptos.tipo=2 and tblmovimientosdetalles.inventarioanterior>0 and tblmovimientosdetalles.idalmacen=pidalmacen),0);
end if;
end if;


#Fertilizantes Salida
if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo<>2),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacen=pidalmacen and tblfertilizantesmovimientos.tipo<>2),0);
end if;
end if;

#fertilizantes recepción
if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad-ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen),0);
end if;
end if;

#fertilizantes traspaso
if pidsucursal>0 then
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantespedidos.idsucursal=pidsucursal),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.pesoneto)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.tipo=2 and tblfertilizantesmovimientos.idalmacen=pidalmacen),0);
end if;
end if;


#Fertilizantes Salida cuando hubo traspaso
if pidsucursal<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.tipo=2),0);
else
if pidalmacen<=0 then
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantespedidos.idsucursal=pidsucursal and tblfertilizantesmovimientos.tipo<>2),0);
else
set vcantidad=vcantidad+ifnull((select sum(tblfertilizantesmovimientos.surtido)
from tblfertilizantesmovimientos inner join tblfertilizantespedidos on tblfertilizantesmovimientos.idpedido=tblfertilizantespedidos.idpedido
where tblfertilizantesmovimientos.fechacancelado<pfecha1 and tblfertilizantesmovimientos.estado=4 and tblfertilizantesmovimientos.idinventario=pidinventario and tblfertilizantesmovimientos.estadosurtido=1 and tblfertilizantesmovimientos.idalmacendestino=pidalmacen and tblfertilizantesmovimientos.tipo<>2),0);
end if;
end if;


return vcantidad;



END $$

DELIMITER ;


insert into tblactualizaciones(version) values('ver 9026 rev 6');

